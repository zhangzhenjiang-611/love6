<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=10" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/jiaofei/css/base.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/jiaofei/css/index.css" />
<script language="javascript" src="__PUBLIC__/jiaofei/js/jquery-1.9.1.js" ></script> 
<script language="javascript" src="__PUBLIC__/jiaofei/js/ServerClock.js" ></script>  
<script language="javascript" type="text/javascript" src="__PUBLIC__/layer/layer.js"></script>
<script language="javascript" type="text/javascript" src="__PUBLIC__/laydate/laydate.js"></script>
<script language="javascript" type="text/javascript" src="__PUBLIC__/jiaofei/js/my.js"></script>
<SCRIPT language=javascript> 
//+---------------------------------------------------  
//| 日期输出字符串，重载了系统的toString方法  
//+---------------------------------------------------  
Date.prototype.toString = function(showWeek)  
{
    var myDate= this;  
    var str = myDate.toLocaleDateString();  
    if (showWeek)  
    {   
        var Week = ['日','一','二','三','四','五','六'];  
        str += ' 星期' + Week[myDate.getDay()];  
    }  
    return str;  
}  
<!-- 
//window.onerror=function(){return true;} 
// --> 
</SCRIPT> 
<script language="javascript">
    window.onload = function (){
        document.onselectstart = function(){
            return false;
        }
        stime();
        daojishi(60);
        $(".btn_area").show();
        $("#confirm").css({"visibility":"hidden"});
        $("#fanhui").css({"visibility":"visible"});
        $("#tuichu").css({"visibility":"visible"});
        $("#business_type").val("自助缴费");
        $("#op_code").val(new Date().Format("yyyyMMddhhmmssS")/*GetRandomNum(10000,99999)*/);
        $("#op_now").val("jiaofei_chose_card_type");
        //导航条---开始
        $("#tishi_dian1").show();
        $("#tishi_dian2").hide();
        $("#tishi_dian3").hide();
        $("#tishi_dian4").hide();
        $("#tishi_1").css({"color":"#ff7800","font-size":"26px"});
        //导航条---结束
        // var re = window.external.getUserId();

        var re = "zzj001";
        $("#zzj_id").val(re);
        // writeLog("选择自助缴费");
        
       
    }
    var c = 0;
    <?php
        $weekary = array("日","一","二","三","四","五","六");
        $W = $weekary[date("w")];
    ?>
    var Y =<?php echo date('Y')?>, M =<?php echo date('n')?>, D =<?php echo date('j')?>;
    function stime(){
        c++
        sec = <?php echo time() - strtotime(date("Y-m-d"))?>+c;
        H = Math.floor(sec / 3600) % 24
        I = Math.floor(sec / 60) % 60
        S = sec % 60
        if (S < 10) S = '0' + S;
        if (I < 10) I = '0' + I;
        if (H < 10) H = '0' + H;
        if (H == '00' & I == '00' & S == '00') D = D + 1; //日进位
        if (M == 2) { //判断是否为二月份******
            if (Y % 4 == 0 && !Y % 100 == 0 || Y % 400 == 0) { //是闰年(二月有28天)
                if (D == 30) {
                    M += 1;
                    D = 1;
                } //月份进位
            }
            else { //非闰年(二月有29天)
                if (D == 29) {
                    M += 1;
                    D = 1;
                } //月份进位
            }
        }
        else { //不是二月份的月份******
            if (M == 4 || M == 6 || M == 9 || M == 11) { //小月(30天)
                if (D == 31) {
                    M += 1;
                    D = 1;
                } //月份进位
            }
            else { //大月(31天)
                if (D == 32) {
                    M += 1;
                    D = 1;
                } //月份进位
            }
        }
       $.ajax({
            url:"__URL__/getdangqian_timme", 
            type:'post',
            dataType:'json',
            success:function(data){
                // $("#show_times").html(data['rq']+"<span style='margin-right:34px;'>"+data['xq']+"</span>"+data['sj'])
                $("#show_times").html(Y + '年&nbsp;&nbsp;' + M + '月' + D + '日 ' +"<span style='margin-left:75px;color:#fff;'>星期<?=$W?></span>") 
            }
        })
        /********************改为一秒执行一次***********************/
        setTimeout("stime()", 30000); 
    }
</script>
<script  language="javascript">
    function setCalls(pat_code,noon_flag){
        var params = {"pat_code":pat_code};
        $.ajax({
            url:"__URL__/setCalls", 
            type:'post',
            dataType:'json',
            data:params,
            success:function(data){
                
            }
        })
    }
</script>
<script language="javascript">
var data,datarow;
var interval = "";
var interval2 = new Array();
var interval3 = new Array();
var countdown = 60;
var jzk_flag = 0;
var page = 1;
var pagedata = null;
var ocx;
var cardNum;
var now_time = null;
var moring_time = null;
var moon_time = null;
function settime(val) {
    if (countdown == 1) { 
        $("#tuichu").trigger("click");
        countdown = 0; 
        clearTimeout(interval2);
        return;
    } else { 
        countdown--; 
        $("#downcount").show().text(countdown);
    } 
    
    var in2 = setTimeout(function() { 
        settime(val) 
    },1000);
    interval2.push(in2);
    
} 
/***
***倒计时函数
********/
function daojishi(etime){
    for(var key in interval2){
        clearTimeout(interval2[key]);
    }
    countdown = etime;
    settime(etime);
}
function backspace(){ //退格
    var vals = $("#jz_card_no").val();
    var vals2 = vals.substring(0,vals.length-1)
    key_value2 = vals2;
    $("#jz_card_no").val(key_value2);
}//取长度为原长度减一的串，实现退格效
/*******金属密码键盘明文调用开始***************/
var key_value2 = "";
function secr_c(str){
    switch(str){
    case "ENTER":
    $("#confirm").trigger("click");
    break;
    case "CLEAR":
    backspace()
    break;
    case "1":
    case "2":
    case "3":
    case "4":
    case "5":
    case "6":
    case "7":
    case "8":
    case "9":
    case "0":
    case "00":
    key_value2+=str;
    break;
    }
    $("#jz_card_no").val(key_value2); 
}

//获取打印纸的状态
// function print_status(zzj_id){
//     var params = {"zzj_id":zzj_id};
//     $.ajax({
//         url:"__URL__/print_status", 
//         type:'post',
//         dataType:'json',
//         data:params,
//         success:function(data){
//         }
//     })
// }

function Transaction(original_cost,current_price){
    // patient_id    患者id
    // user_name     患者姓名
    // out_trade_no  订单号
    // transaction_type  交易类型
    // transaction_mode  支付方式
    // transaction_conente  交易内容
    // original_cost 原价
    // current_price 现价
    // zzj_id        自助机id
    // alert( $("#patient_id").val()+"患者id");
    // alert( $("#patient_name").val()+"患者姓名");
    // alert( $("#stream_no").val()+"订单号");
    // alert( $("#card_code").val()+"交易类型");
    // alert($("#pay_type").val()+"支付方式");
    // alert( $("#business_type").val()+"交易内容");
    // alert( original_cost+"原价");
    // alert(current_price+"现价");
    // alert($("#zzj_id").val()+"自助机id");
   
    var params = {"patient_id":$("#patient_id").val(),"user_name":$("#patient_name").val(),"out_trade_no":$("#stream_no").val(),"transaction_type":$("#card_code").val(),"transaction_mode":$("#pay_type").val(),"transaction_conente":$("#business_type").val(),"original_cost":original_cost,"current_price":current_price,'zzj_id':$("#zzj_id").val()};
    $.ajax({
        url:"__URL__/transaction_logs",
        type:'post',
        dataType:'json',
        data:params,
        success:function(data){}
    })

   
}
/*******金属密码键盘明文调用结束***********************/
$(function(){
// print_status($("#zzj_id").val());
/*******数字键盘区开始*******************************************************************************/
var key_value = "";
$(".j_keybord_area .key li.num").on("mousedown",function(){
    //$(".j_keybord_area .key li").removeClass("active");
    // $(this).addClass("active");
    // key_value+=$(this).attr("param");
    // $("#jz_card_no").val(key_value);
    var jz_card_no=$("#jz_card_no").val();
    var key_value="";
    if(jz_card_no.length>0){
        var key_value=jz_card_no.substr(0,jz_card_no.length+1);
    }
    //alert(key_value);
    $(this).addClass("active");
    key_value+=$(this).attr("param");
    //alert(key_value);
    $("#jz_card_no").val(key_value);

})
$(".j_keybord_area .key li.del").on("click",function(){
    var jz_card_no=$("#jz_card_no").val();
     var a="";
     if(jz_card_no.length>0){
     var a=jz_card_no.substr(0,jz_card_no.length-1);
    }
    $("#jz_card_no").val(a);    
    key_value="";
    key_value2="";
})
$(".j_keybord_area .key li").on("mouseup",function(){
    $(".j_keybord_area .key li").removeClass("active");
    //$(this).addClass("active");
})
//处方序号点击按钮
/*$(document).on("click",".chufang_list ul li.one",function(){
    //首先获取本列的checkbox是否已经被选中
    if($(this).prev(".chk").find("input[type='checkbox']").is(':checked')){
        $(this).prev(".chk").find("input[type='checkbox']").prop("checked",false);
        $(this).addClass("nocheck");
    }else{
        $(this).prev(".chk").find("input[type='checkbox']").prop("checked",true);
        $(this).removeClass("nocheck");
    }
})*/
$(document).on("click",".chufang_list ul li.five",function(){
    if($(this).next(".detail").is(':hidden')){
        $(".chufang_list ul li.five").removeClass("z2");
        $(this).addClass("z2");
        $(".detail").hide();
        $(this).next(".detail").show();
        $(this).text("关闭");
    }else{
        $(this).removeClass("z2");
        $(this).next(".detail").hide();
        $(this).text("展开");
    }
    
})
/*******数字键盘区结束********************************************************************************/

/*******身份证数字键盘开始********************************************************************************/
$(".j_keybord_area_sfz .key li.num").on("mousedown",function(){
    //$(".j_keybord_area .key li").removeClass("active");
    /*$(this).addClass("active");
    key_value+=$(this).attr("param");
    $("#jz_card_no_sfz").val(key_value);*/
    //$(".j_keybord_area .key li").removeClass("active");
    var jz_card_no_sfz=$("#jz_card_no_sfz").val();
    var key_value="";
    if(jz_card_no_sfz.length>0){
        var key_value=jz_card_no_sfz.substr(0,jz_card_no_sfz.length+1);
    }
    //alert(key_value);
    $(this).addClass("active");
    key_value+=$(this).attr("param");
    //alert(key_value);
    $("#jz_card_no_sfz").val(key_value);

})
$(".j_keybord_area_sfz .key li.del").on("click",function(){
    var jz_card_no_sfz=$("#jz_card_no_sfz").val();
     var a="";
     if(jz_card_no_sfz.length>0){
     var a=jz_card_no_sfz.substr(0,jz_card_no_sfz.length-1);
    }
    $("#jz_card_no_sfz").val(a);
})
$(".j_keybord_area_sfz .key li").on("mouseup",function(){
    $(".j_keybord_area_sfz .key li").removeClass("active");
    //$(this).addClass("active");
})
/*******住院输入充值金额数字键盘开始********************************************************************************/
var key_value1 = "";
$(".j_keybord_area_chongzhi_shuru .key li.num").on("mousedown",function(){

    //$(".j_keybord_area .key li").removeClass("active");
    $(this).addClass("active");
    key_value1+=$(this).attr("param");
    $("#chongzhi_money").val(key_value1);

})
$(".j_keybord_area_chongzhi_shuru .key li.del").on("click",function(){
    var chongzhi_money=$("#chongzhi_money").val();
    var a="";
    if(chongzhi_money.length>0){
        var a=chongzhi_money.substr(0,chongzhi_money.length-1);
    }
    $("#chongzhi_money").val(a);    
    
})
$(".j_keybord_area_chongzhi_shuru .key li").on("mouseup",function(){
    $(".j_keybord_area_chongzhi_shuru .key li").removeClass("active");
    //$(this).addClass("active");
})
/*******住院输入充值金额数字键盘结束********************************************************************************/
$("#tuika").click(function(){
    window.external.MoveOutCard();
    //禁止进卡
    window.external.DisAllowCardIn();
})

$('#jz_card_no').keydown(function(e){
    if(e.keyCode==13){
        $("#confirm").trigger("click");
    }
});

$('#jz_card_no_sfz').keydown(function(e){
    if(e.keyCode==13){
      $("#confirm").trigger("click");
    }
});

/************选择了就诊卡***************/
$("#xz_ic").on("click",function(){
    

    $("#card_code").val("3");
    // writeLog("选择了就诊卡");
    $(".chose_card_type_area").hide();
    $(".jiuzhen_op_area").show();
    $(".jiuzhen_op_area .tips").text("");
    $("#jz_card_no").focus();
    $("#op_now").val("ic_get_pat_info");
    $(".btn_area").show();
    $("#fanhui").css({"visibility":"visible"});
    $("#confirm").css({"visibility":"hidden"});
    $("#tuichu").css({"visibility":"visible"});
    // window.external.send(5,2);
    $(".jiuzhen_op_area .tips").text("获取中");
    interval = setInterval(getIcCardNo,"1000");
    interval3.push(interval);
    daojishi(60);
})
/****************选择了身份证*******************/
$("#xz_sfz").on("click",function(){
    $("#card_code").val("2");
    // writeLog("选择了身份证");
    $(".chose_card_type_area").hide();
    $(".jiuzhen_op_area_sfz").show();
    $(".jiuzhen_op_area_sfz .tips").text("");
    $("#jz_card_no_sfz").focus();
    setInterval(function(){
        $("#jz_card_no_sfz").focus();
    },"1000");
    $("#op_now").val("sfz_put_sfz");
    $(".btn_area").show();
    $("#confirm").css({"visibility":"visible"});
    // writeLog("定时判断患者是否放身份证");
    // window.external.send(4,2);
    interval = setInterval(getCardNoS,"1000");
    interval3.push(interval);
    daojishi(60);   
});
/****************选择了医保卡*******************/
$("#xz_yibao").on("click",function(){
    $("#card_code").val("1");
    // writeLog("选择了医保卡");
    $(".mtnum2").hide();
    $(".yb_op_area").show();
     $(".yb_op_area .tips").text("");
    $("#op_now").val("chose_yb_card");
    $(".btn_area").show();
    $("#confirm").css({"visibility":"hidden"});
    $("#fanhui").css({"visibility":"hidden"});
    // window.external.send(2,2);   //开启社保卡灯带
    // window.external.AllowCardIn();//允许社保进卡
    // $(".yb_op_area .tips").show().text('医保患者数据读取中,请稍后...');
    interval = setInterval(getYibaoInfo,"1000");
    interval3.push(interval);
    daojishi(60);
});
/***退出按钮事件***/
$("#tuichu").on("click",function(){
    // writeLog("点击退出退到主界面");
    $(".mtnum2").hide();
    $("#jz_card_no").val("");
    $("#jz_card_no_guahao").val("");
    $("#jz_card_no_guahao_sfz").val("");
    $("#jz_card_no_sfz").val("");
    $(".btn_area").hide();
    $(".op_now").val("");
    $("#jz_name").html("");
    $("#guahao_name").html("");
    $("#keshi_name").html("");
    $("#attr_list").html("");
    $("#sub_list").html("");
    $(".chose_room h4").html("");
    $(".tips").html("");
    $(".pay_ma_show .tips").html("请用手机支付宝扫描付款");
    $(".pay_ma_show_guahao .tips").html("请用手机支付宝扫描付款");
    $(".pay_ma_show_guahao .erweima").html("");  
    $(".pay_ma_show .erweima").html(""); 
    $(".pay_ma_show .pay_val").html("");
    $(".pay_ma_show_guahao .pay_val").html("");
    $(".chufang_list").html("<h4></h4>");
    $(".yb_op_area .tips").html('');
    $(".yb_op_area_guahao .tips_guahao").html('');
    key_value="";
    key_value2="";
    //window.external.KeyBoardComClose();
    //window.external.keybord_close();
    // window.external.Out_UMS_CardClose();
    //window.external.Out_UMS_EjectCard();
    //UMS_EjectCard();
    //UMS_CardClose();
    $(".inhide").val("");
    $("#downcount").hide();
    for(var key in interval2){
        clearTimeout(interval2[key]);
    }
    for(var key in interval3){
        clearInterval(interval3[key]);
    }
    // window.external.webBrowserNavigateHome();
    // window.location.href="__APP__/ZiZhu/Index";
    // window.external.send(1,4); //关闭灯带
    // //退出卡 禁止进卡  自助机要有
    // window.external.MoveOutCard();
    // window.external.DisAllowCardIn();
    // window.external.FreeYBIntfDll();
    window.location.href="__APP__/ZiZhu/Index/index";
    
});
//退出程序
$("#close").on("click",function(){ 
  //alert("123"); 
    window.external.closeWindow();
})

//格式化金额字符串
function cash(cash){
    var money = new Number(cash).toFixed(2);
    var length =parseInt((money*100)).toString().length;
    var n = 12-length;
    var yl_cash="";
    for(i=0;i<n;i++){
        yl_cash+="0";
        }
        return yl_cash+parseInt((money*100).toFixed(2)).toString();
    }
//选择银行卡支付
$("#pay_bank").on("click",function(){
    alert("开发中。。。");
    return;
    $("#op_now").val("xz_yhkpay");
    window.external.send(3,2); //开启银行卡灯带
    $("#pay_type").val("yhk");
    writeLog("选择了银行卡");
   
    var total_amount = cash($("#cash").val());
    $("#total_amount").val(total_amount);
    bank_info  = window.external.CreditTrans("0000"+$("#zzj_id").val()+"0000"+$("#zzj_id").val()+"C"+total_amount+"");  
   writeLog("银行卡交易串："+bank_info); //日志
   var out_trade_no = $("#zzj_id").val()+'jf'+new Date().Format("yyyyMMddhhmmssS");  //银行交易单号
       $("#stream_no").val(out_trade_no); 
   var  RespCode = bank_info.slice(0,2); //交易成功码 
    
   if(RespCode == "00"){
         $(".mtnum2").hide();
        $(".pay_ma_show").hide();
        $(".pay_success").show();
        for(var key in interval2){
          clearTimeout(interval2[key]);
           }
        $(".pay_success h3").show().html("费用确认中,请稍候..."); 
        
         var  patient_name  = $("#patient_name").val();
         var  total_amount  = $("#cash").val();
         var  patient_id  = $("#patient_id").val();

    if( patient_name !=undefined || total_amount != ""  || patient_id != "" ){
         
        var params = {"bank_info":bank_info,"total_amount":$("#cash").val(),"subject":"患者"+$("#patient_name").val()+"自助缴费","out_trade_no":out_trade_no,"patient_id":$("#patient_id").val()}; 
            var index_load = "";
            $.ajax({
                url:"__URL__/yhk_pay", 
                type:'post',
                dataType:'json',
                data:params,              
                success:function(data){  
                    for(var key in interval2){
                clearTimeout(interval2[key]);
                  }         
                    window.external.send(1,4); //关闭灯带
                    if(data["RespCode"]=="00"){
                            // 买家银行卡账号写入隐藏域
                                // alert(data['idCard']+"卡号");
                                // alert(data['ck_no']+"参考号");
                                // 买家银行卡交易号写入隐藏域
                                $("#idCard").val(data['idCard']);
                                 // 买家银行卡凭证号写入隐藏域
                                $("#Auth").val(data['pz_no']);
                                 // 买家银行卡授权号写入隐藏域
                                 if( data['sc_no'] != undefined){
                                     $("#Memo").val(data['sc_no']);
                                 }else{
                                    $("#Memo").val("无");
                                 }
                               
                                 // 买家银行卡交易日期时间写入隐藏域
                                $("#TransDate").val(data['jy_no']);
                                 //银行卡交易状态写入隐藏域
                                $("#trade_no").val(data["ck_no"]); 
                               
                                 /****开始调用缴费确认接口***/
                                $("#PayStatus").val("银行卡支付成功");
                               
                            $("#fanhui").css({"visibility":"hidden"});
                            $("#tuichu").css({"visibility":"hidden"});
                            $("#confirm").css({"visibility":"hidden"});
                            writeLog("银行卡支付成功");                      
                            paySuccessSendToHis($("#card_code").val());

                    }

                }
            })
        }else{

              layer.alert("银行卡交易失败，请联系信息科或者窗口",{
                            icon: 6,
                            skin: 'layer-ext-moon',
                            time:5000,
                        });
               var params = {"bank_info":bank_info,"total_amount":$("#cash").val(),"subject":"患者"+$("#patient_name").val()+"自助挂号","out_trade_no":out_trade_no,"patient_id":$("#patient_id").val()}; 
            var index_load = "";
            $.ajax({
                url:"__URL__/yhk_pay", 
                type:'post',
                dataType:'json',
                data:params,              
                success:function(data){  
                    for(var key in interval2){
                clearTimeout(interval2[key]);
                  }         
                    window.external.send(1,4); //关闭灯带
                    if(data["RespCode"]=="00"){
                            // 买家银行卡账号写入隐藏域
                                // alert(data['idCard']+"卡号");
                                // alert(data['ck_no']+"参考号");
                                // 买家银行卡交易号写入隐藏域
                                $("#idCard").val(data['idCard']);
                                 // 买家银行卡凭证号写入隐藏域
                                $("#Auth").val(data['pz_no']);
                                 // 买家银行卡授权号写入隐藏域
                                 if( data['sc_no'] != undefined){
                                     $("#Memo").val(data['sc_no']);
                                 }else{
                                    $("#Memo").val("无");
                                 }
                               
                                 // 买家银行卡交易日期时间写入隐藏域
                                $("#TransDate").val(data['jy_no']);
                                 //银行卡交易状态写入隐藏域
                                $("#trade_no").val(data["ck_no"]); 
                               
                                 /****开始调用缴费确认接口***/
                                $("#PayStatus").val("银行卡支付成功");
                               
                          
                          writeLog("银行卡支付成功");                      
                          

                    }

                }
            })
        }

   }else{
        writeLog("银行卡支付失败");
       // $("#op_now").val("chose_pay_type");
        $("#tuichu").trigger("click");
        window.external.send(1,4); //关闭灯带
   }




   
})


//选择支付宝支付 
$("#pay_zhifubao").on("click",function(){
    $("#op_now").val("xz_alipay");
    $("#pay_type").val("alipay");
     // writeLog("选择了支付宝");
    var out_trade_no = $("#zzj_id").val()+"jf"+new Date().Format("yyyyMMddhhmmssS");
    $("#stream_no").val(out_trade_no);
    var total_amount = $("#cash").val();
    var params = {"out_trade_no":out_trade_no,"total_amount":total_amount,"subject":"患者"+$("#patient_name").val()+"自助缴费","pay_type":$("#pay_type").val()}; 
    var index_load = "";
    $.ajax({
        url:"__URL__/ajaxGetPayUrl", 
        type:'post',
        dataType:'json',
        data:params,
        beforeSend:function(){
            index_load = layer.msg('支付二维码请求中,请稍候...', {icon: 16,time:20000});
        },
        success:function(data){
            layer.close(index_load);
            daojishi(300);
            $(".mtnum2").hide();
            $(".pay_ma_show").show();
            $("#fanhui").css({"visibility":"hidden"});
            $("#confirm").css({"visibility":"hidden"});
            // $("#tuichu").css({"visibility":"hidden"});
            $("#tuichu").css({"visibility":"visible"});
            $("#stream_no").val(out_trade_no);
            $(".pay_ma_show h3").text("支付宝扫一扫付款");
            $(".pay_ma_show .pay_val").text("￥"+total_amount);
            $("#hedui_2_val").text($("#patient_name").val());
            // $(".pay_ma_show .erweima").html("<img src='http://localhost/rw2.0_payment/zhifubao.png' width='240' />");
            $(".pay_ma_show .erweima").html("<img src='__PUBLIC__/jiaofei/img/zuixin/zhifubao.png' width='240px' />");
            s1 = setInterval(function(){
                getResult(out_trade_no);                             
            },5000); 
            interval2.push(s1);
        }
    })
})
//选择微信支付 
$("#pay_weixin").on("click",function(){
    $("#op_now").val("xz_weixin");
    $("#pay_type").val("wxpay");
     // writeLog("选择了微信");
    var out_trade_no = $("#zzj_id").val()+"jf"+new Date().Format("yyyyMMddhhmmssS");
    $("#stream_no").val(out_trade_no);
    var total_amount = $("#cash").val();
    var params = {"out_trade_no":out_trade_no,"total_amount":total_amount,"subject":"患者"+$("#patient_name").val()+"自助缴费","pay_type":$("#pay_type").val()}; 
    var index_load = "";
    $.ajax({
        url:"__URL__/ajaxGetPayUrl", 
        type:'post',
        dataType:'json',
        data:params,
        beforeSend:function(){
            index_load = layer.msg('支付二维码请求中,请稍候...', {icon: 16,time:20000});
        },
        success:function(data){
            layer.close(index_load);
            $(".mtnum2").hide();
            $(".pay_ma_show").show();
            $("#fanhui").css({"visibility":"hidden"});
            $("#confirm").css({"visibility":"hidden"});
            $("#tuichu").css({"visibility":"hidden"});
            // $("#tuichu").css({"visibility":"visible"});
            daojishi(300);
            $("#stream_no").val(out_trade_no);
             $(".pay_ma_show h3").text("微信扫一扫付款");
            $(".pay_ma_show .pay_val").text("￥"+total_amount);
            $("#hedui_2_val").text($("#patient_name").val());
            // $(".pay_ma_show .erweima").html("<img src='http://localhost/rw2.0_payment/weixin.png' width='240' />");
            $(".pay_ma_show .erweima").html("<img src='__PUBLIC__/jiaofei/img/zuixin/weixin.png' width='240px' />");
            s1 = setInterval(function(){
                getResult(out_trade_no,s1);                             
            },5000); 
            interval2.push(s1);
        }
    }) 
})
/***轮询调用查询接口是否支付成功**/
function getResult(out_trade_no,s1){
    var pay_type = $("#pay_type").val();
    var params = {"out_trade_no":out_trade_no,"pay_type":pay_type};  
    $.ajax({
        url:"__URL__/ajaxGetPayStatus", 
        type:'post',
        dataType:'json',
        data:params,
        success:function(data){
            switch(pay_type){
                case "alipay":
                    // if(data.message.PayStatus=="WAIT_BUYER_PAY"){ 
                        // $("#erweima_show .tips2").hide();
                        $("#tuichu").css({"visibility":"hidden"});
                        $(".pay_ma_show .tips").show().html("<p>等待患者付款中，请在五分钟内完成付款....</p>").css({"color":"red"});
                    // }
                    // if(data.message.PayStatus=="TRADE_SUCCESS" && data.message.OutTradeNo==$("#stream_no").val()){
                        s1 = setInterval(function(){
                            // 买家支付宝账号写入隐藏域
                            // $("#idCard").val(data['message']['BuyerLogonId']);
                            // 买家支付宝交易号写入隐藏域
                            // $("#trade_no").val(data.message.TradeNo);
                            //支付宝交易状态写入隐藏域
                            $("#PayStatus").val("支付宝支付成功");
                            /****开始调用缴费确认接口***/
                            $(".pay_ma_show").hide();
                            $(".pay_success").show();
                            $(".pay_success h3").show().html("费用确认中,请稍候...");
                            for(var key in interval2){
                                clearTimeout(interval2[key]);
                            }
                            // writeLog("支付宝支付成功");
                            $("#fanhui").css({"visibility":"hidden"});
                            $("#tuichu").css({"visibility":"hidden"});
                            $("#confirm").css({"visibility":"hidden"});
                            //通知HIS保存
                            // return;
                            paySuccessSendToHis($("#card_code").val());
                        },3000);
                    // }
                break;
                case "wxpay":
                    // if(data.message.return_code=="SUCCESS"&&data.message.result_code=="SUCCESS" && data.message.out_trade_no==$("#stream_no").val()){
                    //     switch(data.message.PayStatus){
                            // case "NOTPAY":
                            //     $("#erweima_show .tips2").hide();
                            //     // $("#erweima_show .tips").show().html("<p>等待用户付款中，请在三分钟内完成付款....</p>");
                            // break;
                            // case "SUCCESS":
                                // $("#erweima_show .pic").hide();
                                $("#erweima_show .tips").html("").hide();
                                $("#erweima_show .tips2").hide();
                                $("#erweima_show .jine").hide();
                                // 买家微信账号openid(用户在商户appid下的唯一标识)写入隐藏域
                                // $("#idCard").val(data['message']['openid']);
                                // 买家微信订单号写入隐藏域
                                // $("#trade_no").val(data.message.transaction_id);
                                //微信交易状态写入隐藏域
                                $("#PayStatus").val("微信支付成功");
                                /****开始调用缴费确认接口***/
                                $(".pay_ma_show").hide();
                                $(".pay_success").show();
                                $(".pay_success h3").show().html("费用确认中,请稍候...");
                                for(var key in interval2){
                                    clearTimeout(interval2[key]);
                                }
                                // writeLog("微信支付成功");
                                $("#fanhui").css({"visibility":"hidden"});
                                $("#tuichu").css({"visibility":"hidden"});
                                $("#confirm").css({"visibility":"hidden"});
                                //通知HIS保存
                                paySuccessSendToHis($("#card_code").val());
                            // break;
                    //     }
                    // }
                break;
            }
        }
    })      
}
/***支付成功回写HIS库***/
function paySuccessSendToHis(card_code){
    $("#yes_success").show();
    $("#not_success").hide();
    $(".pay_success h3").html("支付成功"+"<br>请收好就诊凭证,就诊卡。");
    $("#tuichu").css({"visibility":"hidden"});
    // alert(123);
    daojishi(3);
    return;

    $("#fanhui").css({"visibility":"hidden"});
    $("#tuichu").css({"visibility":"hidden"});
    if($("#business_type").val()=="自助缴费"){
        switch(card_code){
            case '3'://就诊卡
                var index_load="";
                var params = {"card_code":$("#card_code").val(),"card_no":$("#card_no").val(),"patient_id":$("#patient_id").val(),"OrderNum":$("#OrderNum").val(),"charge_total":$("#charge_total").val(),"cash":$("#cash").val(),"zhzf":$("#zhzf").val(),"tczf":$("#tczf").val(),"trade_no":$("#trade_no").val(),"pay_type":$("#pay_type").val(),"PayAccount":$("#idCard").val(),"trade_no":$("#trade_no").val(),"stream_no":$("#stream_no").val(),"op_code":$("#op_code").val(),"zzj_id":$("#zzj_id").val(),"ksdm":$("#ksdm").val(),"jzid":$("#jzid").val(),"order_no":$("#order_no").val(),"if_ck":$("#if_ck").val(),"zhzf":$("#zhzf").val(),"djh":$("#sf_djh").val(),"patient_name":$("#patient_name").val()};
                $.ajax({
                    url:"__URL__/ic_jiaofei_save", 
                    type:'post',
                    dataType:'json',
                    data:params,                  
                    success:function(data){                                                 
                        var tk_status="";//退款状态
                        var mx="";//明细
                        var pt="";
                         var date  = new Date().Format("yyyy-MM-dd hh:mm:ss");
                         
                        if(data['head']['succflag']=="1"){
                            window.external.send(1,2);   //开启凭条灯带
                            writeLog("收据号："+ data['body']['rctpno']);
                            writeLog("HIS缴费保存成功");
                            $(".pay_success h3").html("支付成功"+"<br>请收好就诊凭证,就诊卡。");
                            //开始往数据库添加数据
                             Transaction($("#cash").val(),$("#cash").val());
                            var age =$("#patient_age").val();//患者年龄                                            
                            var ID = data['body']['medid'];//患者ID  门诊号
                            var sex = $("#patient_sex").val();//患者性别;
                               if(sex == "1"){
                                      sex = '男';
                                }else{
                                      sex = '女';
                                }                                 
                            var charge_total  =  data['body']["chargetamt"]; //总金额
                            var  cash  =  data['body']["personamt"];   //个人支付
                            var location_info = data['body']['medwd'];//患者就诊位置 
                            var rctpno =  data['body']['rctpno'];
                            var mingxi_list = data['mx'];
                            var mingxi = data["mingxi"];
                            var s1="";
                            var pos = 0;
                            s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                            s1 += "<tr font='黑体' type='text' size='12' x='20' y='" + (pos += 10) + "' >首都医科大学附属北京潞河医院(缴费)</tr>";
                            s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+ID+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 55) + "' >卡类型:就诊卡</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";                           
                            s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 15) + "' >门诊号:"+ID+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >姓名:"+$("#patient_name").val()+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >性别:"+sex+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >年龄:"+age+"</tr>";                           
                            s1 += "<tr font='黑体' type='text' size='12' x='100' y='" + (pos += 30) +"' >收 费 明 细 单</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                            if(mingxi_list.length!=undefined){

                                for(var i=0;i<mingxi_list.length;i++){
                                   //if(mingxi_list[i]['itemclass'] == "中草药"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >项目分类</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >金额</tr>";                       
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                         s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >"+mingxi_list[i]['itemclass']+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >"+mingxi_list[i]['amt']+"元</tr>";
                                        
                                   // }
                                   
                                }   
                            }
                               s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                            
                              if(mingxi.length!=undefined){
                                   
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >单价</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='80' y='" + (pos += 0) + "' >规格</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >数量</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='200' y='" + (pos += 0) + "' >单位</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='255' y='" + (pos += 0) + "' >金额</tr>";                       
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                                                  
                                    for(var j=0;j<mingxi.length;j++){
                                             s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >名称 "+mingxi[j]['itemname']+"</tr>";
                                           
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >"+mingxi[j]['price']+"元</tr>";
                                              if( mingxi[j]['itemspec'].length != "" ){
                                                  s1 += "<tr font='黑体' type='text' size='10' x='80' y='" + (pos += 0) + "' >"+mingxi[j]['itemspec']+"</tr>";
                                              }
                                            
                                            s1 += "<tr font='黑体' type='text' size='10' x='160' y='" + (pos += 0) + "' >"+mingxi[j]['quantity']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='205' y='" + (pos += 0) + "' >"+mingxi[j]['unit']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='255' y='" + (pos += 0) + "' >"+mingxi[j]['amt']+"</tr>";
                                            // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保分类 "+mingxi[j]['medclass']+"</tr>";
                                            // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >开票项目 "+mingxi[j]['kpxm']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                    }                                
                            
                            }
                           
                           
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >总费用："+ charge_total+"元</tr>";
                            if($("#pay_type").val()=="alipay"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝支付："+$("#cash").val()+"元</tr>";
                            }
                            if($("#pay_type").val()=="yhk"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡支付："+$("#cash").val()+"元</tr>";
                            }
                            if($("#pay_type").val()=="wxpay"){
                               s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信支付："+$("#cash").val()+"元</tr>";
                            }
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >个人账户：0元</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保基金支付：0元</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >实收:"+cash+"元</tr>";
                           
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >机器编号:"+$("#zzj_id").val()+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >打印时间:"+date+"</tr>";
                            if($("#pay_type").val()=="alipay"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝帐号："+$("#idCard").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝单号："+$("#stream_no").val()+"</tr>";
                                }
                            if($("#pay_type").val()=="yhk"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡号："+$("#idCard").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易单号："+$("#stream_no").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行凭证号："+$("#Auth").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行授权号："+$("#Memo").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易时间："+$("#TransDate").val()+"</tr>";
                                }
                            if($("#pay_type").val()=="wxpay"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信交易单号："+$("#stream_no").val()+"</tr>";
                                }
                            s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 20) + "' >支付状态:"+$("#PayStatus").val()+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >流水号："+$("#trade_no").val()+"</tr>";
                            // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >收据号："+rctpno+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >缴费单当日有效,退费有效期为24小时,逾期作废</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请保存此凭证,做为打印发票凭证</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请持医生签字发票,做为退费凭证</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：如需退费请去窗口处理</tr>";                   
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：此凭证不作为报销凭证</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                            s1 += "</print_info>";
                            // alert(s1);
                            window.external.paint(s1);
                            //导引单
                            if (data['daoyin']['head']['succflag'] == '1') {
                                if (data['daoyin']["body"]['rowcount'] != 0) {
                                    var count_list = data['daoyin']["body"]['rowcount'];
                                    var mingxi = data['daoyin']["body"]['Item'];
                                    var s1="";
                                    var pos = 0;
                                    s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                    s1 += "<tr font='黑体' type='text' size='12' x='90' y='" + (pos += 10) + "' >导引单(自助缴费)</tr>";
                                    s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+$("#patient_id").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 55) + "' >卡类型:就诊卡</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";                           
                                    s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 15) + "' >门诊号:"+data['daoyin']['body']['patientid']+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 20) + "' >姓名:"+data['daoyin']['body']['name']+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >打印时间："+new Date().Format("yyyy-MM-dd hh:mm:ss")+"</tr>";
                                    if(mingxi!=undefined){
                                        if (count_list == 1 ) {
                                            var str1 = mingxi['address'];
                                            var cd1 = Math.ceil(str1.length/21);
                                            for(j=0;j<cd1;j++){
                                                s1 += "<tr font='黑体' type='text' size='10' x='35' y='" + (pos += 20) + "' >"+str1.replace(/(.{21})/g,'$1|').split("|")[j]+"</tr>";
                                            }
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                        }else{
                                            for(var i=0;i<count_list;i++){
                                                var str1 = mingxi[i]['address'];
                                                var cd1 = Math.ceil(str1.length/21);
                                                for(j=0;j<cd1;j++){
                                                    s1 += "<tr font='黑体' type='text' size='10' x='35' y='" + (pos += 20) + "' >"+str1.replace(/(.{21})/g,'$1|').split("|")[j]+"</tr>";
                                                }
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                            }
                                        }
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                    s1 += "</print_info>";
                                    window.external.paint(s1);
                                };
                                
                            };
                             //检查单
                            if (data['jiancha']['head']['succflag'] == '1') {
                                if (data['jiancha']["body"]['rowcount'] != 0) {
                                    var count_list = data['jiancha']["body"]['rowcount'];
                                    var mingxi = data['jiancha']["body"]['Item'];
                                    var s1="";
                                    var pos = 0;
                                    var sex = $("#patient_sex").val();//患者性别;
                                       if(sex == "1"){
                                              sex = '男';
                                        }else{
                                              sex = '女';
                                        }
                                    s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                    s1 += "<tr font='黑体' type='text' size='12' x='90' y='" + (pos += 10) + "' >检查单(自助缴费)</tr>";
                                    if(mingxi!=undefined){
                                        if (count_list == 1 ) {
                                            var str1 = mingxi['diagnose'];
                                            var str2 = mingxi['part'];
                                            var str3 = mingxi['instruction'];
                                            var cd1 = Math.ceil(str1.length/15);
                                            var cd2 = Math.ceil(str2.length/15);
                                            var cd3 = Math.ceil(str3.length/15);
                                            s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 25) + "' >卡类型:就诊卡</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >门诊号:"+mingxi['patientid']+"</tr>";
                                            s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi['patientid']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >申请单:"+mingxi['applyno']+"</tr>";
                                            s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi['applyno']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >姓名:"+mingxi['name']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='140' y='" + (pos += 0) + "' >年龄:"+$("#patient_age").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='220' y='" + (pos += 0) + "' >性别:"+sex+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >开单科室:"+mingxi['deptname']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >医生:"+mingxi['doctor']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查科室:"+mingxi['executdepartment']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >金额:"+mingxi['total']+"</tr>";
                                            for(j=0;j<cd1;j++){
                                                if (j ==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >诊断:"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }else{
                                                     s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }
                                               
                                            }
                                            for(j=0;j<cd2;j++){
                                                if (j ==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >部位:"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }else{
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }
                                                
                                            }
                                            for(j=0;j<cd3;j++){
                                                if (j ==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查说明:"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }else{
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }
                                                
                                            }
                                            
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                        }else{
                                            for(var i=0;i<count_list;i++){
                                                var str1 = mingxi[i]['diagnose'];
                                                var str2 = mingxi[i]['part'];
                                                var str3 = mingxi[i]['instruction'];
                                                var cd1 = Math.ceil(str1.length/15);
                                                var cd2 = Math.ceil(str2.length/15);
                                                var cd3 = Math.ceil(str3.length/15);
                                                if (i==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 25) + "' >卡类型:就诊卡</tr>";
                                                };
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >门诊号:"+mingxi[i]['patientid']+"</tr>";
                                                s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi[i]['patientid']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >申请单:"+mingxi[i]['applyno']+"</tr>";
                                                s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi[i]['applyno']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >姓名:"+mingxi[i]['name']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='140' y='" + (pos += 0) + "' >年龄:"+$("#patient_age").val()+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='220' y='" + (pos += 0) + "' >性别:"+sex+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >开单科室:"+mingxi[i]['deptname']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >医生:"+mingxi[i]['doctor']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查科室:"+mingxi[i]['executdepartment']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >金额:"+mingxi[i]['total']+"</tr>";
                                                for(j=0;j<cd1;j++){
                                                    if (j ==0) {
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >诊断:"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }else{
                                                         s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }
                                                   
                                                }
                                                for(j=0;j<cd2;j++){
                                                    if (j ==0) {
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >部位:"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }else{
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }
                                                    
                                                }
                                                for(j=0;j<cd3;j++){
                                                    if (j ==0) {
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查说明:"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }else{
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }
                                                    
                                                }
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                            }
                                        }
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                    s1 += "</print_info>";
                                    window.external.paint(s1);
                                };
                            }; 
                        }else{
                            writeLog("HIS缴费保存失败");
                             window.external.send(1,2);   //开启凭条灯带
                            var paramss = {"card_code":$("#card_code").val(),"card_no":$("#card_no").val(),"patient_id":$("#patient_id").val(),"trade_no":$("#trade_no").val(),"op_code":$("#op_code").val(),"zzj_id":$("#zzj_id").val()};
                            $.ajax({
                                url:"__URL__/his_record", 
                                type:'post',
                                dataType:'json',
                                data:paramss,
                                success:function(rel){
                                    if(rel['success']=="FAIL"){
                                        writeLog("HIS无记录,可以退款");
                                         if($("#pay_type").val()=="yhk"  && data['head']['succflag']=="2"){
                                
                                                 var total_amount = $("#total_amount").val();                               
                                                 var  bank_info1  = window.external.CreditTrans("0000"+$("#zzj_id").val()+"0000"+$("#zzj_id").val()+"H"+total_amount+""+$("#Auth").val());  
                                                 writeLog("银行卡交易成功his回退串："+bank_info1); //日志
                                                  var paramssyhk = {"tk_status":bank_info1,"zzj_id":$("#zzj_id").val(),"out_trade_no":$("#stream_no").val()}
                                                     $.ajax({
                                                            url:"__URL__/yhk_tk", 
                                                            type:'post',
                                                            dataType:'json',
                                                            data:paramssyhk,
                                                            success:function(){}
                                                    })
                                                  $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",银行卡已退费");
                                                //微信进行回退
                                              }else if($("#pay_type").val()=="wxpay" && data['head']['succflag']=="2"){

                                                $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",微信正在退费");
                                                 writeLog("his失败,微信可以退款");
                                                 do_tuikuan($("#trade_no").val(),$("#stream_no").val(),$("#cash").val(),$("#zzj_id").val());
                 
                                              }else if($("#pay_type").val()=="alipay" && data['head']['succflag']=="2"){
                                               // 支付宝进行回退
                                                 $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",支付宝正在退费");
                                                 writeLog("his失败,支付宝可以退款");
                                                 do_tuikuan($("#trade_no").val(),$("#stream_no").val(),$("#cash").val(),$("#zzj_id").val());
                                              }
                                    }else{
                                        writeLog("HIS有记录,不可以退款");
                                         $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",请去收费窗口处理");
                                        var age =$("#patient_age").val();//患者年龄                                            
                                        var ID =  $("#patient_id").val();//患者ID  门诊号
                                        var sex = $("#patient_sex").val();//患者性别;
                                           if(sex == "1"){
                                                  sex = '男';
                                            }else{
                                                  sex = '女';
                                            }        
                                      
                                        var s1="";
                                        var pos = 0;
                                        s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                        s1 += "<tr font='黑体' type='text' size='12' x='20' y='" + (pos += 10) + "' >首都医科大学附属北京潞河医院(缴费)</tr>";
                                        s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+ID+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 55) + "' >卡类型:就诊卡</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                         if($("#pay_type").val()=="yhk" && data['head']['succflag']=="2"){
                                          s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";                           
                                          s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >银行卡已退费</tr>";

                                        }else{
                                          s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";
                                          s1 += "<tr font='黑体' type='text' size='25' x='45' y='" + (pos += 40) + "' >请保存此凭证</tr>";
                                          s1 += "<tr font='黑体' type='text' size='25' x='1' y='" + (pos += 40) + "' >微信,支付宝,银行卡</tr>";
                                          s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >请当天去窗口退费</tr>";

                                        };
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >---------------------------------------------</tr>";
                                        s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 15) + "' >门诊号:"+ID+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >姓名:"+$("#patient_name").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >性别:"+sex+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >年龄:"+age+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >总费用："+$("#charge_total").val()+"元</tr>";
                                        if($("#pay_type").val()=="alipay"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝支付："+$("#cash").val()+"元</tr>";
                                        }
                                        if($("#pay_type").val()=="yhk"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡支付："+$("#cash").val()+"元</tr>";
                                        }
                                        if($("#pay_type").val()=="wxpay"){
                                           s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信支付："+$("#cash").val()+"元</tr>";
                                        }
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >个人账户："+$("#zhzf").val()+"元</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保基金支付："+$("#tczf").val()+"元</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >实收:"+$("#cash").val()+"元</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >机器编号:"+$("#zzj_id").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >打印时间:"+date+"</tr>";
                                        if($("#pay_type").val()=="alipay"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝帐号："+$("#idCard").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝单号："+$("#stream_no").val()+"</tr>";
                                        }
                                        if($("#pay_type").val()=="yhk"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡号："+$("#idCard").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易单号："+$("#stream_no").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行凭证号："+$("#Auth").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行授权号："+$("#Memo").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易时间："+$("#TransDate").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易状态：交易已回退</tr>";
                                        }
                                        if($("#pay_type").val()=="wxpay"){
                                            s1 += "<tr font='黑体' type='text' size='9' x='10' y='" + (pos += 20) + "' >微信交易单号："+$("#stream_no").val()+"</tr>";
                                        }
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付状态:支付成功</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >流水号："+$("#trade_no").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请保存此凭证，做为退费凭证</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                        s1 += "</print_info>";
                                        // alert(s1);
                                        window.external.paint(s1);
                                       
                                  
                                  }

                               }
                            });
                           
                                   
                              
                            
                
                        }
                        //开始记录交易信息
                        // 支付类型(如自助缴费)
                        var business_type = $("#business_type").val();
                        // 卡类型(0是就诊卡 1是医保卡)
                        var card_type = $("#card_code").val();
                        // 就诊卡卡号或者医保卡号
                        var pat_card_no = $("#card_no").val();
                        // 买家支付宝账号
                        var id_card_no = $("#idCard").val();
                        // 病人ID
                        var pat_id = $("#patient_id").val();
                        // 病人姓名
                        var pat_name = $("#patient_name").val();
                        // 病人性别
                        var pat_sex = $("#patient_sex").val();
                        // 自费加医保支付总金额
                        var charge_total = $("#chargetamt").val();
                        // 支付宝,微信支付金额
                        var cash = $("#cash").val();
                        // 医保个人封闭账号支付
                        var zhzf = 0;
                        // 医保统筹支付
                        var tczf = $("#chargetamt").val()-$("#cash").val();
                        // 支付宝微信交易状态
                        var trading_state = $("#PayStatus").val();
                        // HIS状态
                        var his_state = data["head"]["retcode"];
                        // 买家支付宝，微信交易号
                        var trade_no = $("#trade_no").val();
                        // 自助机id
                        var zzj_id =$("#zzj_id").val();
                        // 订单支付时传入的商户订单号
                        var stream_no = $("#stream_no").val();
                        // 支付方式(如alipay,wxpay)
                        var pay_type = $("#pay_type").val();
                        pay_record(business_type,card_type,pat_card_no,id_card_no,pat_id,pat_name,pat_sex,charge_total,cash,zhzf,tczf,trading_state,his_state,trade_no,zzj_id,stream_no,pay_type);
                        daojishi(10);
                        // setTimeout(function(){
                        //  $("#fanhui").trigger("click"); 
                        // },10000);
                    }
                });
            break;
            case '2'://身份证
                var index_load="";
                var params = {"card_code":$("#card_code").val(),"card_no":$("#card_no").val(),"patient_id":$("#patient_id").val(),"OrderNum":$("#OrderNum").val(),"charge_total":$("#charge_total").val(),"cash":$("#cash").val(),"zhzf":$("#zhzf").val(),"tczf":$("#tczf").val(),"trade_no":$("#trade_no").val(),"pay_type":$("#pay_type").val(),"PayAccount":$("#idCard").val(),"trade_no":$("#trade_no").val(),"stream_no":$("#stream_no").val(),"op_code":$("#op_code").val(),"zzj_id":$("#zzj_id").val(),"ksdm":$("#ksdm").val(),"jzid":$("#jzid").val(),"order_no":$("#order_no").val(),"if_ck":$("#if_ck").val(),"zhzf":$("#zhzf").val(),"djh":$("#sf_djh").val(),"patient_name":$("#patient_name").val()};
                $.ajax({
                    url:"__URL__/ic_jiaofei_save", 
                    type:'post',
                    dataType:'json',
                    data:params,                  
                    success:function(data){                                                 
                        var tk_status="";//退款状态
                        var mx="";//明细
                        var pt="";
                         var date  = new Date().Format("yyyy-MM-dd hh:mm:ss");
                         
                        if(data['head']['succflag']=="1"){
                            window.external.send(1,2);   //开启凭条灯带
                            writeLog("收据号："+ data['body']['rctpno']);
                            writeLog("HIS缴费保存成功");
                            $(".pay_success h3").html("支付成功"+"<br>请收好就诊凭证,身份证。");
                            //开始往数据库添加数据
                             Transaction($("#cash").val(),$("#cash").val());
                            var age =$("#patient_age").val();//患者年龄                                            
                            var ID = data['body']['medid'];//患者ID  门诊号
                            var sex = $("#patient_sex").val();//患者性别;
                               if(sex == "1"){
                                      sex = '男';
                                }else{
                                      sex = '女';
                                }                                 
                            var charge_total  =  data['body']["chargetamt"]; //总金额
                            var  cash  =  data['body']["personamt"];   //个人支付
                            var location_info = data['body']['medwd'];//患者就诊位置 
                            var rctpno =  data['body']['rctpno'];
                            var mingxi_list = data['mx'];
                            var mingxi = data["mingxi"];
                            var s1="";
                            var pos = 0;
                            s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                            s1 += "<tr font='黑体' type='text' size='12' x='20' y='" + (pos += 10) + "' >首都医科大学附属北京潞河医院(缴费)</tr>";
                            s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+ID+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 55) + "' >卡类型:身份证</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";                           
                            s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 15) + "' >门诊号:"+ID+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >姓名:"+$("#patient_name").val()+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >性别:"+sex+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >年龄:"+age+"</tr>";                           
                            s1 += "<tr font='黑体' type='text' size='12' x='100' y='" + (pos += 30) +"' >收 费 明 细 单</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                            if(mingxi_list.length!=undefined){

                                for(var i=0;i<mingxi_list.length;i++){
                                   //if(mingxi_list[i]['itemclass'] == "中草药"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >项目分类</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >金额</tr>";                       
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                         s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >"+mingxi_list[i]['itemclass']+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >"+mingxi_list[i]['amt']+"元</tr>";
                                        
                                   // }
                                   
                                }   
                            }
                               s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                            
                              if(mingxi.length!=undefined){
                                   
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >单价</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='80' y='" + (pos += 0) + "' >规格</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >数量</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='200' y='" + (pos += 0) + "' >单位</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='255' y='" + (pos += 0) + "' >金额</tr>";                       
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                                                  
                                    for(var j=0;j<mingxi.length;j++){
                                          // if(mingxi[j]['kpxm'] !="中成费"){
                                            
                                                    
                                             s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >名称 "+mingxi[j]['itemname']+"</tr>";
                                           
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >"+mingxi[j]['price']+"元</tr>";
                                              if( mingxi[j]['itemspec'].length != "" ){
                                                  s1 += "<tr font='黑体' type='text' size='10' x='80' y='" + (pos += 0) + "' >"+mingxi[j]['itemspec']+"</tr>";
                                              }
                                            
                                            s1 += "<tr font='黑体' type='text' size='10' x='160' y='" + (pos += 0) + "' >"+mingxi[j]['quantity']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='205' y='" + (pos += 0) + "' >"+mingxi[j]['unit']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='255' y='" + (pos += 0) + "' >"+mingxi[j]['amt']+"</tr>";
                                            // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保分类 "+mingxi[j]['medclass']+"</tr>";
                                            // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >开票项目 "+mingxi[j]['kpxm']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";

                                          // }
                                                                                 
                                    }                                
                            
                            }
                           
                           
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >总费用："+ charge_total+"元</tr>";
                            if($("#pay_type").val()=="alipay"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝支付："+$("#cash").val()+"元</tr>";
                            }
                            if($("#pay_type").val()=="yhk"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡支付："+$("#cash").val()+"元</tr>";
                            }
                            if($("#pay_type").val()=="wxpay"){
                               s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信支付："+$("#cash").val()+"元</tr>";
                            }
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >个人账户：0元</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保基金支付：0元</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >实收:"+cash+"元</tr>";
                           
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >机器编号:"+$("#zzj_id").val()+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >打印时间:"+date+"</tr>";
                            if($("#pay_type").val()=="alipay"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝帐号："+$("#idCard").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝单号："+$("#stream_no").val()+"</tr>";
                                }
                            if($("#pay_type").val()=="yhk"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡号："+$("#idCard").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易单号："+$("#stream_no").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行凭证号："+$("#Auth").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行授权号："+$("#Memo").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易时间："+$("#TransDate").val()+"</tr>";
                                }
                            if($("#pay_type").val()=="wxpay"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信交易单号："+$("#stream_no").val()+"</tr>";
                                }
                            s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 20) + "' >支付状态:"+$("#PayStatus").val()+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >流水号："+$("#trade_no").val()+"</tr>";
                            // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >收据号："+rctpno+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >缴费单当日有效,退费有效期为24小时,逾期作废</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请保存此凭证,做为打印发票凭证</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请持医生签字发票,做为退费凭证</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：如需退费请去窗口处理</tr>";                   
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：此凭证不作为报销凭证</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                            s1 += "</print_info>";
                            // alert(s1);
                            window.external.paint(s1);
                            //导引单
                            if (data['daoyin']['head']['succflag'] == '1') {
                                if (data['daoyin']["body"]['rowcount'] != 0) {
                                    var count_list = data['daoyin']["body"]['rowcount'];
                                    var mingxi = data['daoyin']["body"]['Item'];
                                    var s1="";
                                    var pos = 0;
                                    s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                    s1 += "<tr font='黑体' type='text' size='12' x='90' y='" + (pos += 10) + "' >导引单(自助缴费)</tr>";
                                    s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+$("#patient_id").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 55) + "' >卡类型:身份证</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";                           
                                    s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 15) + "' >门诊号:"+data['daoyin']['body']['patientid']+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 20) + "' >姓名:"+data['daoyin']['body']['name']+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >打印时间："+new Date().Format("yyyy-MM-dd hh:mm:ss")+"</tr>";
                                    if(mingxi!=undefined){
                                        if (count_list == 1 ) {
                                            var str1 = mingxi['address'];
                                            var cd1 = Math.ceil(str1.length/21);
                                            for(j=0;j<cd1;j++){
                                                s1 += "<tr font='黑体' type='text' size='10' x='35' y='" + (pos += 20) + "' >"+str1.replace(/(.{21})/g,'$1|').split("|")[j]+"</tr>";
                                                
                                            }
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                        }else{
                                            for(var i=0;i<count_list;i++){
                                                var str1 = mingxi[i]['address'];
                                                var cd1 = Math.ceil(str1.length/21);
                                                for(j=0;j<cd1;j++){
                                                    s1 += "<tr font='黑体' type='text' size='10' x='35' y='" + (pos += 20) + "' >"+str1.replace(/(.{21})/g,'$1|').split("|")[j]+"</tr>";
                                                    
                                                }
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                            }
                                        }
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                    s1 += "</print_info>";
                                    window.external.paint(s1);
                                };
                                
                            };
                             //检查单
                            if (data['jiancha']['head']['succflag'] == '1') {
                                if (data['jiancha']["body"]['rowcount'] != 0) {
                                    var count_list = data['jiancha']["body"]['rowcount'];
                                    var mingxi = data['jiancha']["body"]['Item'];
                                    var s1="";
                                    var pos = 0;
                                    var sex = $("#patient_sex").val();//患者性别;
                                       if(sex == "1"){
                                              sex = '男';
                                        }else{
                                              sex = '女';
                                        }
                                    s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                    s1 += "<tr font='黑体' type='text' size='12' x='90' y='" + (pos += 10) + "' >检查单(自助缴费)</tr>";
                                    if(mingxi!=undefined){
                                        if (count_list == 1 ) {
                                            var str1 = mingxi['diagnose'];
                                            var str2 = mingxi['part'];
                                            var str3 = mingxi['instruction'];
                                            var cd1 = Math.ceil(str1.length/15);
                                            var cd2 = Math.ceil(str2.length/15);
                                            var cd3 = Math.ceil(str3.length/15);
                                            s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 25) + "' >卡类型:身份证</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >门诊号:"+mingxi['patientid']+"</tr>";
                                            s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi['patientid']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >申请单:"+mingxi['applyno']+"</tr>";
                                            s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi['applyno']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >姓名:"+mingxi['name']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='140' y='" + (pos += 0) + "' >年龄:"+$("#patient_age").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='220' y='" + (pos += 0) + "' >性别:"+sex+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >开单科室:"+mingxi['deptname']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >医生:"+mingxi['doctor']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查科室:"+mingxi['executdepartment']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >金额:"+mingxi['total']+"</tr>";
                                            for(j=0;j<cd1;j++){
                                                if (j ==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >诊断:"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }else{
                                                     s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }
                                               
                                            }
                                            for(j=0;j<cd2;j++){
                                                if (j ==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >部位:"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }else{
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }
                                                
                                            }
                                            for(j=0;j<cd3;j++){
                                                if (j ==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查说明:"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }else{
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }
                                                
                                            }
                                            
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                        }else{
                                            for(var i=0;i<count_list;i++){
                                                var str1 = mingxi[i]['diagnose'];
                                                var str2 = mingxi[i]['part'];
                                                var str3 = mingxi[i]['instruction'];
                                                var cd1 = Math.ceil(str1.length/15);
                                                var cd2 = Math.ceil(str2.length/15);
                                                var cd3 = Math.ceil(str3.length/15);
                                                if (i==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 25) + "' >卡类型:身份证</tr>";
                                                };
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >门诊号:"+mingxi[i]['patientid']+"</tr>";
                                                s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi[i]['patientid']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >申请单:"+mingxi[i]['applyno']+"</tr>";
                                                s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi[i]['applyno']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >姓名:"+mingxi[i]['name']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='140' y='" + (pos += 0) + "' >年龄:"+$("#patient_age").val()+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='220' y='" + (pos += 0) + "' >性别:"+sex+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >开单科室:"+mingxi[i]['deptname']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >医生:"+mingxi[i]['doctor']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查科室:"+mingxi[i]['executdepartment']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >金额:"+mingxi[i]['total']+"</tr>";
                                                for(j=0;j<cd1;j++){
                                                    if (j ==0) {
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >诊断:"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }else{
                                                         s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }
                                                   
                                                }
                                                for(j=0;j<cd2;j++){
                                                    if (j ==0) {
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >部位:"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }else{
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }
                                                    
                                                }
                                                for(j=0;j<cd3;j++){
                                                    if (j ==0) {
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查说明:"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }else{
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }
                                                    
                                                }
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                            }
                                        }
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                    s1 += "</print_info>";
                                    window.external.paint(s1);
                                };
                            };   
                        }else{
                            writeLog("HIS缴费保存失败");
                             window.external.send(1,2);   //开启凭条灯带
                            var paramss = {"card_code":$("#card_code").val(),"card_no":$("#card_no").val(),"patient_id":$("#patient_id").val(),"trade_no":$("#trade_no").val(),"op_code":$("#op_code").val(),"zzj_id":$("#zzj_id").val()};
                            $.ajax({
                                url:"__URL__/his_record", 
                                type:'post',
                                dataType:'json',
                                data:paramss,
                                success:function(rel){
                                    if(rel['success']=="FAIL"){
                                        writeLog("HIS无记录,可以退款");
                                         if($("#pay_type").val()=="yhk"  && data['head']['succflag']=="2"){
                                
                                                 var total_amount = $("#total_amount").val();                               
                                                 var  bank_info1  = window.external.CreditTrans("0000"+$("#zzj_id").val()+"0000"+$("#zzj_id").val()+"H"+total_amount+""+$("#Auth").val());  
                                                 writeLog("银行卡交易成功his回退串："+bank_info1); //日志
                                                 var paramssyhk = {"tk_status":bank_info1,"zzj_id":$("#zzj_id").val(),"out_trade_no":$("#stream_no").val()}
                                                     $.ajax({
                                                            url:"__URL__/yhk_tk", 
                                                            type:'post',
                                                            dataType:'json',
                                                            data:paramssyhk,
                                                            success:function(){}
                                                    })
                                                  $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",银行卡已退费");
                                                //微信进行回退
                                              }else if($("#pay_type").val()=="wxpay" && data['head']['succflag']=="2"){

                                                $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",微信正在退费");
                                                 writeLog("his失败,微信可以退款");
                                                 do_tuikuan($("#trade_no").val(),$("#stream_no").val(),$("#cash").val(),$("#zzj_id").val());
                 
                                              }else if($("#pay_type").val()=="alipay" && data['head']['succflag']=="2"){
                                               // 支付宝进行回退
                                                 $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",支付宝正在退费");
                                                 writeLog("his失败,支付宝可以退款");
                                                 do_tuikuan($("#trade_no").val(),$("#stream_no").val(),$("#cash").val(),$("#zzj_id").val());
                                              }
                                    }else{
                                        writeLog("HIS有记录,不可以退款");
                                         $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",请去收费窗口处理");
                                        var age =$("#patient_age").val();//患者年龄                                            
                                        var ID =  $("#patient_id").val();//患者ID  门诊号
                                        var sex = $("#patient_sex").val();//患者性别;
                                           if(sex == "1"){
                                                  sex = '男';
                                            }else{
                                                  sex = '女';
                                            }        
                                      
                                        var s1="";
                                        var pos = 0;
                                        s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                        s1 += "<tr font='黑体' type='text' size='12' x='20' y='" + (pos += 10) + "' >首都医科大学附属北京潞河医院(缴费)</tr>";
                                        s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+ID+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 55) + "' >卡类型:就诊卡</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                         if($("#pay_type").val()=="yhk" && data['head']['succflag']=="2"){
                                          s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";                           
                                          s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >银行卡已退费</tr>";

                                        }else{
                                          s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";
                                          s1 += "<tr font='黑体' type='text' size='25' x='45' y='" + (pos += 40) + "' >请保存此凭证</tr>";
                                          s1 += "<tr font='黑体' type='text' size='25' x='1' y='" + (pos += 40) + "' >微信,支付宝,银行卡</tr>";
                                          s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >请当天去窗口退费</tr>";

                                        };
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >---------------------------------------------</tr>";
                                        s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 15) + "' >门诊号:"+ID+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >姓名:"+$("#patient_name").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >性别:"+sex+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >年龄:"+age+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >总费用："+$("#charge_total").val()+"元</tr>";
                                        if($("#pay_type").val()=="alipay"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝支付："+$("#cash").val()+"元</tr>";
                                        }
                                        if($("#pay_type").val()=="yhk"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡支付："+$("#cash").val()+"元</tr>";
                                        }
                                        if($("#pay_type").val()=="wxpay"){
                                           s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信支付："+$("#cash").val()+"元</tr>";
                                        }
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >个人账户："+$("#zhzf").val()+"元</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保基金支付："+$("#tczf").val()+"元</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >实收:"+$("#cash").val()+"元</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >机器编号:"+$("#zzj_id").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >打印时间:"+date+"</tr>";
                                        if($("#pay_type").val()=="alipay"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝帐号："+$("#idCard").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝单号："+$("#stream_no").val()+"</tr>";
                                        }
                                        if($("#pay_type").val()=="yhk"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡号："+$("#idCard").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易单号："+$("#stream_no").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行凭证号："+$("#Auth").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行授权号："+$("#Memo").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易时间："+$("#TransDate").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易状态：交易已回退</tr>";
                                        }
                                        if($("#pay_type").val()=="wxpay"){
                                            s1 += "<tr font='黑体' type='text' size='9' x='10' y='" + (pos += 20) + "' >微信交易单号："+$("#stream_no").val()+"</tr>";
                                        }
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付状态:支付成功</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >流水号："+$("#trade_no").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请保存此凭证，做为退费凭证</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                        s1 += "</print_info>";
                                        // alert(s1);
                                        window.external.paint(s1);
                                       
                                  
                                  }

                               }
                            });
                           
                                   
                              
                            
                
                        }
                        //开始记录交易信息
                        // 支付类型(如自助缴费)
                        var business_type = $("#business_type").val();
                        // 卡类型(0是就诊卡 1是医保卡)
                        var card_type = $("#card_code").val();
                        // 就诊卡卡号或者医保卡号
                        var pat_card_no = $("#card_no").val();
                        // 买家支付宝账号
                        var id_card_no = $("#idCard").val();
                        // 病人ID
                        var pat_id = $("#patient_id").val();
                        // 病人姓名
                        var pat_name = $("#patient_name").val();
                        // 病人性别
                        var pat_sex = $("#patient_sex").val();
                        // 自费加医保支付总金额
                        var charge_total = $("#chargetamt").val();
                        // 支付宝,微信支付金额
                        var cash = $("#cash").val();
                        // 医保个人封闭账号支付
                        var zhzf = 0;
                        // 医保统筹支付
                        var tczf = $("#chargetamt").val()-$("#cash").val();
                        // 支付宝微信交易状态
                        var trading_state = $("#PayStatus").val();
                        // HIS状态
                        var his_state = data["head"]["retcode"];
                        // 买家支付宝，微信交易号
                        var trade_no = $("#trade_no").val();
                        // 自助机id
                        var zzj_id =$("#zzj_id").val();
                        // 订单支付时传入的商户订单号
                        var stream_no = $("#stream_no").val();
                        // 支付方式(如alipay,wxpay)
                        var pay_type = $("#pay_type").val();
                        pay_record(business_type,card_type,pat_card_no,id_card_no,pat_id,pat_name,pat_sex,charge_total,cash,zhzf,tczf,trading_state,his_state,trade_no,zzj_id,stream_no,pay_type);
                        daojishi(10);
                        
                    }
                });
            break;
            case '1'://医保卡
                var index_load="";
                var params = {"card_code":$("#card_code").val(),"card_no":$("#card_no").val(),"patient_id":$("#patient_id").val(),"OrderNum":$("#OrderNum").val(),"charge_total":$("#charge_total").val(),"cash":$("#cash").val(),"zhzf":$("#zhzf").val(),"tczf":$("#tczf").val(),"trade_no":$("#trade_no").val(),"pay_type":$("#pay_type").val(),"PayAccount":$("#idCard").val(),"trade_no":$("#trade_no").val(),"stream_no":$("#stream_no").val(),"op_code":$("#op_code").val(),"zzj_id":$("#zzj_id").val(),"ksdm":$("#ksdm").val(),"jzid":$("#jzid").val(),"order_no":$("#order_no").val(),"if_ck":$("#if_ck").val(),"zhzf":$("#zhzf").val(),"djh":$("#sf_djh").val(),"chargetamt":$("#charge_total").val()};
                $.ajax({
                    url:"__URL__/yibao_jiaofei_save", 
                    type:'post',
                    dataType:'json',
                    data:params,
                    success:function(data){
                      var tk_status="";//退款状态
                        var mx="";//明细
                        var pt="";
                         var date  = new Date().Format("yyyy-MM-dd hh:mm:ss");
                          
                        if(data['head']['succflag']=="1"){
                            window.external.send(1,2);   //开启凭条灯带
                            writeLog("收据号："+ data['body']['rctpno']);
                            writeLog("HIS缴费保存成功");                            
                            $(".pay_success h3").html("支付成功"+"<br>请收好就诊凭证,医保卡。");
                            //开始往数据库添加数据
                            Transaction($("#charge_total").val(),$("#cash").val());
                            var age =$("#patient_age").val();//患者年龄                                            
                            var ID = data['body']['medid'];//患者ID  门诊号
                            var sex = $("#patient_sex").val();//患者性别;
                               if(sex == "1"){
                                      sex = '男';
                                }else{
                                      sex = '女';
                                }                                 
                            var charge_total  =  data['body']["chargetamt"]; //总金额
                            var  cash  =  data['body']["personamt"];   //个人支付
                            var location_info = data['body']['medwd'];//患者就诊位置 
                            var rctpno =  data['body']['rctpno']; //收据号
                            var mingxi_list = data['mx'];
                             var mingxi = data["mingxi"];
                            var s1="";
                            var pos = 0;
                            s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                            s1 += "<tr font='黑体' type='text' size='12' x='20' y='" + (pos += 10) + "' >首都医科大学附属北京潞河医院(缴费)</tr>";
                            s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+ID+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 55) + "' >卡类型:医保卡</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";                           
                            s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 15) + "' >门诊号:"+ID+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 20) + "' >医保卡号:"+$("#card_no").val()+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >姓名:"+$("#patient_name").val()+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >性别:"+sex+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >年龄:"+age+"</tr>";                           
                            s1 += "<tr font='黑体' type='text' size='12' x='100' y='" + (pos += 30) +"' >收 费 明 细 单</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                          
                             if(mingxi_list.length!=undefined){

                                for(var i=0;i<mingxi_list.length;i++){
                                   //if(mingxi_list[i]['itemclass'] == "中草药"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >项目分类</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >金额</tr>";                       
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                         s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >"+mingxi_list[i]['itemclass']+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >"+mingxi_list[i]['amt']+"元</tr>";
                                   // }
                                   
                                }   
                            }
                             s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";

                            
                            if(mingxi.length!=undefined){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >单价</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='80' y='" + (pos += 0) + "' >规格</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='150' y='" + (pos += 0) + "' >数量</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='200' y='" + (pos += 0) + "' >单位</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='255' y='" + (pos += 0) + "' >金额</tr>";                       
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";                         
                                    for(var j=0;j<mingxi.length;j++){
                                          // if(mingxi[j]['kpxm'] !="中成费"){

                                             s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >名称 "+mingxi[j]['itemname']+"</tr>";
                                           
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >"+mingxi[j]['price']+"元</tr>";
                                              if( mingxi[j]['itemspec'].length != "" ){
                                                  s1 += "<tr font='黑体' type='text' size='10' x='80' y='" + (pos += 0) + "' >"+mingxi[j]['itemspec']+"</tr>";
                                              }
                                            s1 += "<tr font='黑体' type='text' size='10' x='160' y='" + (pos += 0) + "' >"+mingxi[j]['quantity']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='205' y='" + (pos += 0) + "' >"+mingxi[j]['unit']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='255' y='" + (pos += 0) + "' >"+mingxi[j]['amt']+"</tr>";
                                            // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保分类 "+mingxi[j]['medclass']+"</tr>";
                                            // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >开票项目 "+mingxi[j]['kpxm']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";

                                          }
                                                                                 
                                    // }                                
                            
                            }
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >总费用："+ charge_total+"元</tr>";
                            if($("#pay_type").val()=="alipay"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝支付："+$("#cash").val()+"元</tr>";
                            }
                            if($("#pay_type").val()=="yhk"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡支付："+$("#cash").val()+"元</tr>";
                            }
                            if($("#pay_type").val()=="wxpay"){
                               s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信支付："+$("#cash").val()+"元</tr>";
                            }
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保个人账户："+$("#zhzf").val()+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保基金支付："+$("#tczf").val()+"</tr>";
                              // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保个人账户余额："+$("#personcount").val()+"元</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >实收:"+cash+"元</tr>";
                            
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >机器编号:"+$("#zzj_id").val()+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >打印时间:"+date+"</tr>";
                            if($("#pay_type").val()=="alipay"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝帐号："+$("#idCard").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝单号："+$("#stream_no").val()+"</tr>";
                                }
                            if($("#pay_type").val()=="yhk"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡号："+$("#idCard").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易单号："+$("#stream_no").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行凭证号："+$("#Auth").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行授权号："+$("#Memo").val()+"</tr>";
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易时间："+$("#TransDate").val()+"</tr>";
                                }
                            if($("#pay_type").val()=="wxpay"){
                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信交易单号："+$("#stream_no").val()+"</tr>";
                                }
                            s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 20) + "' >支付状态:"+$("#PayStatus").val()+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >流水号："+$("#trade_no").val()+"</tr>";
                            // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >收据号："+rctpno+"</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >缴费单当日有效,退费有效期为24小时,逾期作废</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请保存此凭证,做为打印发票凭证</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请持医生签字发票,做为退费凭证</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：如需退费请去窗口处理</tr>";                   
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：此凭证不作为报销凭证</tr>";
                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                            s1 += "</print_info>";
                            // alert(s1);
                            window.external.paint(s1);
                            //导引单
                            if (data['daoyin']['head']['succflag'] == '1') {
                                if (data['daoyin']["body"]['rowcount'] != 0) {
                                    var count_list = data['daoyin']["body"]['rowcount'];
                                    var mingxi = data['daoyin']["body"]['Item'];
                                    var s1="";
                                    var pos = 0;
                                    s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                    s1 += "<tr font='黑体' type='text' size='12' x='90' y='" + (pos += 10) + "' >导引单(自助缴费)</tr>";
                                    s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+$("#patient_id").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 55) + "' >卡类型:医保卡</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";                           
                                    s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 15) + "' >门诊号:"+data['daoyin']['body']['patientid']+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 20) + "' >姓名:"+data['daoyin']['body']['name']+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >打印时间："+new Date().Format("yyyy-MM-dd hh:mm:ss")+"</tr>";
                                    if(mingxi!=undefined){
                                        if (count_list == 1 ) {
                                            var str1 = mingxi['address'];
                                            var cd1 = Math.ceil(str1.length/21);
                                            for(j=0;j<cd1;j++){
                                                s1 += "<tr font='黑体' type='text' size='10' x='35' y='" + (pos += 20) + "' >"+str1.replace(/(.{21})/g,'$1|').split("|")[j]+"</tr>";
                                                
                                            }
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                        }else{
                                            for(var i=0;i<count_list;i++){
                                                var str1 = mingxi[i]['address'];
                                                var cd1 = Math.ceil(str1.length/21);
                                                for(j=0;j<cd1;j++){
                                                    s1 += "<tr font='黑体' type='text' size='10' x='35' y='" + (pos += 20) + "' >*"+str1.replace(/(.{21})/g,'$1|').split("|")[j]+"</tr>";
                                                    
                                                }
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                            }
                                        }
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                    s1 += "</print_info>";
                                    
                                    window.external.paint(s1);
                                };
                                
                            };
                             //检查单
                            if (data['jiancha']['head']['succflag'] == '1') {
                                if (data['jiancha']["body"]['rowcount'] != 0) {
                                    var count_list = data['jiancha']["body"]['rowcount'];
                                    var mingxi = data['jiancha']["body"]['Item'];
                                    var s1="";
                                    var pos = 0;
                                    var sex = $("#patient_sex").val();//患者性别;
                                       if(sex == "1"){
                                              sex = '男';
                                        }else{
                                              sex = '女';
                                        }
                                    s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                    s1 += "<tr font='黑体' type='text' size='12' x='90' y='" + (pos += 10) + "' >检查单(自助缴费)</tr>";
                                    if(mingxi!=undefined){
                                        if (count_list == 1 ) {
                                            var str1 = mingxi['diagnose'];
                                            var str2 = mingxi['part'];
                                            var str3 = mingxi['instruction'];
                                            var cd1 = Math.ceil(str1.length/15);
                                            var cd2 = Math.ceil(str2.length/15);
                                            var cd3 = Math.ceil(str3.length/15);
                                            s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 25) + "' >卡类型:医保卡</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >门诊号:"+mingxi['patientid']+"</tr>";
                                            s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi['patientid']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >申请单:"+mingxi['applyno']+"</tr>";
                                            s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi['applyno']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >姓名:"+mingxi['name']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='140' y='" + (pos += 0) + "' >年龄:"+$("#patient_age").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='220' y='" + (pos += 0) + "' >性别:"+sex+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >开单科室:"+mingxi['deptname']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >医生:"+mingxi['doctor']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查科室:"+mingxi['executdepartment']+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >金额:"+mingxi['total']+"</tr>";
                                            for(j=0;j<cd1;j++){
                                                if (j ==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >诊断:"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }else{
                                                     s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }
                                               
                                            }
                                            for(j=0;j<cd2;j++){
                                                if (j ==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >部位:"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }else{
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }
                                                
                                            }
                                            for(j=0;j<cd3;j++){
                                                if (j ==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查说明:"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }else{
                                                    s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                }
                                                
                                            }
                                            
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                        }else{
                                            for(var i=0;i<count_list;i++){
                                                var str1 = mingxi[i]['diagnose'];
                                                var str2 = mingxi[i]['part'];
                                                var str3 = mingxi[i]['instruction'];
                                                var cd1 = Math.ceil(str1.length/15);
                                                var cd2 = Math.ceil(str2.length/15);
                                                var cd3 = Math.ceil(str3.length/15);
                                                if (i==0) {
                                                    s1 += "<tr font='黑体' type='text' size='10' x='50' y='" + (pos += 25) + "' >卡类型:医保卡</tr>";
                                                };
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >门诊号:"+mingxi[i]['patientid']+"</tr>";
                                                s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi[i]['patientid']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 15) + "' >申请单:"+mingxi[i]['applyno']+"</tr>";
                                                s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='170' y='" + (pos += 0) + "' >"+mingxi[i]['applyno']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 60) + "' >---------------------------------------</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >姓名:"+mingxi[i]['name']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='140' y='" + (pos += 0) + "' >年龄:"+$("#patient_age").val()+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='220' y='" + (pos += 0) + "' >性别:"+sex+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >开单科室:"+mingxi[i]['deptname']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >医生:"+mingxi[i]['doctor']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查科室:"+mingxi[i]['executdepartment']+"</tr>";
                                                s1 += "<tr font='黑体' type='text' size='10' x='190' y='" + (pos += 0) + "' >金额:"+mingxi[i]['total']+"</tr>";
                                                for(j=0;j<cd1;j++){
                                                    if (j ==0) {
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >诊断:"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }else{
                                                         s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str1.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }
                                                   
                                                }
                                                for(j=0;j<cd2;j++){
                                                    if (j ==0) {
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >部位:"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }else{
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str2.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }
                                                    
                                                }
                                                for(j=0;j<cd3;j++){
                                                    if (j ==0) {
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >检查说明:"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }else{
                                                        s1 += "<tr font='黑体' type='text' size='10' x='30' y='" + (pos += 20) + "' >"+str3.replace(/(.{15})/g,'$1|').split("|")[j]+"</tr>";
                                                    }
                                                    
                                                }
                                                s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 15) + "' >---------------------------------------</tr>";
                                            }
                                        }
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                    s1 += "</print_info>";
                                    window.external.paint(s1);
                                };
                            };  
                        }else{
                            writeLog("HIS缴费保存失败");
                            window.external.send(1,2);   //开启凭条灯带  
                            var paramss = {"card_code":$("#card_code").val(),"card_no":$("#card_no").val(),"patient_id":$("#patient_id").val(),"trade_no":$("#trade_no").val(),"op_code":$("#op_code").val(),"zzj_id":$("#zzj_id").val()};
                        
                              $.ajax({
                                url:"__URL__/his_record", 
                                type:'post',
                                dataType:'json',
                                data:paramss,
                                success:function(rel){
                                    if(rel['success']=="FAIL"){
                                        writeLog("HIS无记录,可以退款");
                                        //银行卡进行回退
                                     if($("#pay_type").val()=="yhk"  && data['head']['succflag']=="2"){
                                         
                                         var total_amount = $("#total_amount").val();                               
                                         var  bank_info1  = window.external.CreditTrans("0000"+$("#zzj_id").val()+"0000"+$("#zzj_id").val()+"H"+total_amount+""+$("#Auth").val());  
                                         writeLog("银行卡交易成功his回退串："+bank_info1); //日志
                                         var paramssyhk = {"tk_status":bank_info1,"zzj_id":$("#zzj_id").val(),"out_trade_no":$("#stream_no").val()}
                                                     $.ajax({
                                                            url:"__URL__/yhk_tk", 
                                                            type:'post',
                                                            dataType:'json',
                                                            data:paramssyhk,
                                                            success:function(){}
                                                    })
                                         $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",银行卡已退费");
                                        //微信进行回退
                                      }else if($("#pay_type").val()=="wxpay" && data['head']['succflag']=="2"){

                                        $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",微信正在退费");
                                         writeLog("his失败,微信可以退款");
                                         do_tuikuan($("#trade_no").val(),$("#stream_no").val(),$("#cash").val(),$("#zzj_id").val());
         
                                      }else if($("#pay_type").val()=="alipay" && data['head']['succflag']=="2"){
                                       // 支付宝进行回退
                                         $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",支付宝正在退费");
                                         writeLog("his失败,支付宝可以退款");
                                         do_tuikuan($("#trade_no").val(),$("#stream_no").val(),$("#cash").val(),$("#zzj_id").val());
                                      }
                            
                            }else{
                                $(".pay_success h3").show().html("支付成功,"+data['head']['retmsg']+",请去收费窗口处理");
                                       var retcode = data["head"]["retcode"];
                                        if(retcode == "3032"){
                                            sblx = "医保卡缴费失败";
                                        }else{
                                            sblx = "HIS缴费保存失败";
                                        }
                                        var age =$("#patient_age").val();//患者年龄                                            
                                        var ID =  $("#patient_id").val();//患者ID  门诊号
                                        var sex = $("#patient_sex").val();//患者性别;
                                           if(sex == "1"){
                                                  sex = '男';
                                            }else{
                                                  sex = '女';
                                            }        
                                        //保存失败
                                       // var riqi =  data['result']['info']['account'];//HIS返回挂号日期时间
                                        var s1="";
                                        var pos = 0;
                                        s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                        s1 += "<tr font='黑体' type='text' size='12' x='20' y='" + (pos += 10) + "' >首都医科大学附属北京潞河医院(缴费)</tr>";
                                        s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+ID+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 55) + "' >卡类型:医保卡</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                       if($("#pay_type").val()=="yhk" && data['head']['succflag']=="2"){
                                          s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";                           
                                          s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >银行卡已退费</tr>";

                                        }else{
                                          s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";
                                          s1 += "<tr font='黑体' type='text' size='25' x='45' y='" + (pos += 40) + "' >请保存此凭证</tr>";
                                          s1 += "<tr font='黑体' type='text' size='25' x='1' y='" + (pos += 40) + "' >微信,支付宝,银行卡</tr>";
                                          s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >请当天去窗口退费</tr>";

                                        };
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >---------------------------------------------</tr>";
                                        s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 15) + "' >门诊号:"+ID+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保卡号:"+$("#card_no").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >姓名:"+$("#patient_name").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >性别:"+sex+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >年龄:"+age+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >总费用："+$("#charge_total").val()+"元</tr>";
                                        if($("#pay_type").val()=="alipay"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝支付："+$("#cash").val()+"元</tr>";
                                        }
                                        if($("#pay_type").val()=="yhk"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡支付："+$("#cash").val()+"元</tr>";
                                        }
                                        if($("#pay_type").val()=="wxpay"){
                                           s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信支付："+$("#cash").val()+"元</tr>";
                                        }
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >个人账户："+$("#zhzf").val()+"元</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保基金支付："+$("#tczf").val()+"元</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >实收:"+$("#cash").val()+"元</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >机器编号:"+$("#zzj_id").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >打印时间:"+date+"</tr>";
                                        if($("#pay_type").val()=="alipay"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝帐号："+$("#idCard").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝单号："+$("#stream_no").val()+"</tr>";
                                        }
                                        if($("#pay_type").val()=="yhk"){
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡号："+$("#idCard").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易单号："+$("#stream_no").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行凭证号："+$("#Auth").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行授权号："+$("#Memo").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易时间："+$("#TransDate").val()+"</tr>";
                                            s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行交易状态：交易已回退</tr>";
                                        }
                                        if($("#pay_type").val()=="wxpay"){
                                            s1 += "<tr font='黑体' type='text' size='9' x='10' y='" + (pos += 20) + "' >微信交易单号："+$("#stream_no").val()+"</tr>";
                                        }
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付状态:支付成功</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >流水号："+$("#trade_no").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >失败类型："+sblx+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请保存此凭证，做为退费凭证</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                        s1 += "</print_info>";
                                        // alert(s1);
                                        window.external.paint(s1);
                                      };

                                  

                                }
                            });  
                             
                
                        }
                        window.external.MoveOutCard();
                        window.external.DisAllowCardIn();
                        //开始记录交易信息
                        // 支付类型(如自助缴费)
                        var business_type = $("#business_type").val();
                        // 卡类型(0是就诊卡 1是医保卡)
                        var card_type = $("#card_code").val();
                        // 就诊卡卡号或者医保卡号
                        var pat_card_no = $("#card_no").val();
                        // 买家支付宝账号
                        var id_card_no = $("#idCard").val();
                        // 病人ID
                        var pat_id = $("#patient_id").val();
                        // 病人姓名
                        var pat_name = $("#patient_name").val();
                        // 病人性别
                        var pat_sex = $("#patient_sex").val();
                        // 自费加医保支付总金额
                        var charge_total = $("#chargetamt").val();
                        // 支付宝,微信支付金额
                        var cash = $("#cash").val();
                        // 医保个人封闭账号支付
                        var zhzf = 0;
                        // 医保统筹支付
                        var tczf = $("#chargetamt").val()-$("#cash").val();
                        // 支付宝微信交易状态
                        var trading_state = $("#PayStatus").val();
                        // HIS状态
                        var his_state = data["head"]["retcode"];
                        // 买家支付宝，微信交易号
                        var trade_no = $("#trade_no").val();
                        // 自助机id
                        var zzj_id =$("#zzj_id").val();
                        // 订单支付时传入的商户订单号
                        var stream_no = $("#stream_no").val();
                        // 支付方式(如alipay,wxpay)
                        var pay_type = $("#pay_type").val();
                        pay_record(business_type,card_type,pat_card_no,id_card_no,pat_id,pat_name,pat_sex,charge_total,cash,zhzf,tczf,trading_state,his_state,trade_no,zzj_id,stream_no,pay_type);
                        daojishi(10);
                        // setTimeout(function(){
                        //  $("#fanhui").trigger("click"); 
                        // },10000);
                    }
                });
            break;
            default:
            layer.msg("未知错误", {icon: 14,time:2000});
            break;
        }
    }
}
/*****确定按钮点击事件**********/
$("#confirm").on("click",function(){
    var op_now = $("#op_now").val();
    for(var key in interval3){
        clearInterval(interval3[key]);
    }
    /**获取就诊卡患者信息**/
    switch(op_now){
        case "ic_get_pat_info":
            //导航条---开始
            $("#tishi_dian1").hide();
            $("#tishi_dian2").show();
            $("#tishi_dian3").hide();
            $("#tishi_dian4").hide();
            $("#tishi_1").css({"color":"#666","font-size":"24px"});
            $("#tishi_2").css({"color":"#ff7800","font-size":"26px"});
            //导航条---结束

            // window.external.send(1,4);
            // $("#op_now").val("ic_get_pat_info");
            //获取就诊卡号的值
            var card_no = $("#card_no").val();
            // alert(card_no);
            var business_type = $("#business_type").val();
            var params = {"card_code":$("#card_code").val(),"card_no":card_no,"op_code":$("#op_code").val(),"zzj_id":$("#zzj_id").val(),"business_type":business_type}; 
            var index_load = "";
            $.ajax({
                url:"__URL__/ic_getPatInfo", 
                type:'post',
                dataType:'json',
                data:params,
                beforeSend:function(){
                    index_load = layer.msg('患者就诊数据查询中,请稍候...', {icon: 16,time:20000});
                    $("#fanhui").css({"visibility":"hidden"});
                    $("#confirm").css({"visibility":"hidden"});
                    $("#tuichu").css({"visibility":"hidden"});
                    $(".jiuzhen_op_area .tips").text("");
                },
                success:function(data){
                    layer.close(index_load);
                    if(data['head']['succflag']=="1"){
                        daojishi(90);                       
                        $("#op_now").val("ic_pay_chufang_show");
                        $("#confirm").css({"visibility":"hidden"});
                        $("#fanhui").css({"visibility":"hidden"});
                        $("#tuichu").css({"visibility":"visible"});
                        $(".mtnum2").hide();
                        $(".chufang_area").show();
                        var pat_name = data['body']['name'];//患者姓名
                        var pat_id = data['body']['medid'];//患者ID
                        var patient_sex = data['body']['sex'];//患者性别
                        var age =data["body"]["age"];
                        $("#patient_age").val(age);
                        $("#patient_name").val(pat_name); // 病人姓名放入隐藏域
                        $("#patient_id").val(pat_id); // 病人ID放入隐藏域
                        $("#patient_sex").val(patient_sex); // 病人ID放入隐藏域
                        $(".chufang_area #jz_name").text(pat_name);
                        if(data['chufang']['result']['execute_flag']==1){                        
                            var html="";
                            $("#confirm").css({"visibility":"visible"});
                            $("#fanhui").css({"visibility":"hidden"});
                            var flist = data['chufang']['datarow']["0"]['attr'];   //处方药品信息为空 值为0                         
                            if(flist != "0"){
                                var cflist = data['chufang']['datarow']
                                 for(var i=0;i<cflist.length;i++){
                                  var sub_html = "";
                                  var sub_item = data['chufang']['datarow'][i]['sub'];  //判断是否有药品信息
                                  if(sub_item !="0"){
                                     for(var m=0;m<sub_item.length;m++){
                                           sub_html+="<tr><td align='center'>"+(m+1)+"</td><td>"+sub_item[m]['itemname']+"</td><td>"+sub_item[m]['quantity']+"</td><td>"+sub_item[m]['price']+"</td><td>"+sub_item[m]['unit']+"</td><td>"+sub_item[m]['amt']+"</td></tr>";
                                       }
                                      }else{
                                           sub_html+="<tr><td align='center'>"+(m+1)+"</td><td></td><td></td><td></td><td></td><td></td></tr>";

                                        }
                                html+="<ul><li class='chk'><input type='checkbox' name='times_order_no[]' value='"+cflist[i].attr.chargeid+"'  checked='checked' /></li><li class='one'>"+cflist[i].attr.chargeid+"</li><li class='two'>"+cflist[i].attr.departmentname+"</li><li class='thr'>"+cflist[i].attr.chargeamt+"</li><li class='four'>"+cflist[i].attr.meddate+"</li><li class='five z1'>展开</li><table class='detail' style='display:none;'><tr><th>序号</th><th>名称</th><th>数量</th><th>单价</th><th>单位</th><th>费用</th></tr>"+sub_html+"</table></ul>";
                            }

                             $(".chufang_list").html(html);

                        }else{
                            $("#confirm").css({"visibility":"hidden"});
                            $("#fanhui").css({"visibility":"hidden"});
                            $("#tuichu").css({"visibility":"visible"});
                            $(".chufang_list h4").html("暂无缴费信息");

                        }
       
                    }else{
                        $("#confirm").css({"visibility":"hidden"});
                        $("#fanhui").css({"visibility":"hidden"});
                        $("#tuichu").css({"visibility":"visible"});
                        $(".chufang_list h4").html(data['chufang']['result']['execute_message']);
                    }
                 }else{
                        $("#confirm").css({"visibility":"visible"});
                        $("#fanhui").css({"visibility":"visible"});
                        $("#tuichu").css({"visibility":"visible"});
                        $(".jiuzhen_op_area .tips").text(data['head']['retmsg']);
                        $("#jz_card_no").val("")
                        $("#card_no").val("");
                          daojishi(60);
                    }
                       
                }
            });
        break;
        case "sfz_put_sfz":
            // 获取身份证号
            var sfz_no = $("#jz_card_no_sfz").val();
            // alert(sfz_no);
            // 清空输入框中的值
            $("#jz_card_no_sfz").val("");
            key_value = "";
            $(".jiuzhen_op_area_sfz .tips").text("");
            if(sfz_no.length!="18" && sfz_no.length!="15"){
                interval = setInterval(getCardNoS,"1000");
                interval3.push(interval);
                $(".jiuzhen_op_area_sfz .tips").text("输入有误,请重新输入");
                return;
            }
            // window.external.send(1,4);
            $("#op_now").val("ic_get_pat_info");
            //获取就诊卡号的值
            var card_no = $("#card_no").val();
            var business_type = $("#business_type").val();
            var params = {"card_code":$("#card_code").val(),"card_no":card_no,"op_code":$("#op_code").val(),"zzj_id":$("#zzj_id").val(),"business_type":business_type}; 
            var index_load = "";
            $.ajax({
                url:"__URL__/sfz_getPatInfo", 
                type:'post',
                dataType:'json',
                data:params,
                beforeSend:function(){
                    index_load = layer.msg('患者就诊数据查询中,请稍候...', {icon: 16,time:20000});
                    $("#fanhui").css({"visibility":"hidden"});
                    $("#confirm").css({"visibility":"hidden"});
                    $("#tuichu").css({"visibility":"hidden"});
                    $(".jiuzhen_op_area .tips").text("");
                },
                success:function(data){
                    layer.close(index_load);
                    if(data['head']['succflag']=="1"){
                        daojishi(60);                       
                        $("#op_now").val("ic_pay_chufang_show");
                        $("#confirm").css({"visibility":"hidden"});
                        $("#fanhui").css({"visibility":"hidden"});
                        $("#tuichu").css({"visibility":"visible"});
                        $(".mtnum2").hide();
                        $(".chufang_area").show();
                        var pat_name = data['body']['name'];//患者姓名
                        var pat_id = data['body']['medid'];//患者ID
                        var patient_sex = data['body']['sex'];//患者性别
                        var age =data["body"]["age"];
                        $("#patient_age").val(age);
                        $("#patient_name").val(pat_name); // 病人姓名放入隐藏域
                        $("#patient_id").val(pat_id); // 病人ID放入隐藏域
                        $("#patient_sex").val(patient_sex); // 病人ID放入隐藏域
                        $(".chufang_area #jz_name").text(pat_name);
                        if(data['chufang']['result']['execute_flag']==1){                        
                            var html="";
                            $("#confirm").css({"visibility":"visible"});
                            $("#fanhui").css({"visibility":"hidden"});
                            var flist = data['chufang']['datarow']["0"]['attr'];   //处方药品信息为空 值为0                         
                            if(flist != "0"){
                                //导航条---开始
                                $("#tishi_dian1").hide();
                                $("#tishi_dian2").show();
                                $("#tishi_dian3").hide();
                                $("#tishi_dian4").hide();
                                $("#tishi_1").css({"color":"#666","font-size":"24px"});
                                $("#tishi_2").css({"color":"#ff7800","font-size":"26px"});
                                //导航条---结束
                                var cflist = data['chufang']['datarow']
                                 for(var i=0;i<cflist.length;i++){
                                  var sub_html = "";
                                  var sub_item = data['chufang']['datarow'][i]['sub'];  //判断是否有药品信息
                                  if(sub_item !="0"){
                                     for(var m=0;m<sub_item.length;m++){
                                           sub_html+="<tr><td align='center'>"+(m+1)+"</td><td>"+sub_item[m]['itemname']+"</td><td>"+sub_item[m]['quantity']+"</td><td>"+sub_item[m]['price']+"</td><td>"+sub_item[m]['unit']+"</td><td>"+sub_item[m]['amt']+"</td></tr>";
                                       }
                                      }else{
                                           sub_html+="<tr><td align='center'>"+(m+1)+"</td><td></td><td></td><td></td><td></td><td></td></tr>";

                                        }
                                html+="<ul><li class='chk'><input type='checkbox' name='times_order_no[]' value='"+cflist[i].attr.chargeid+"'  checked='checked' /></li><li class='one'>"+cflist[i].attr.chargeid+"</li><li class='two'>"+cflist[i].attr.departmentname+"</li><li class='thr'>"+cflist[i].attr.chargeamt+"</li><li class='four'>"+cflist[i].attr.meddate+"</li><li class='five z1'>展开</li><table class='detail' style='display:none;'><tr><th>序号</th><th>名称</th><th>数量</th><th>单价</th><th>单位</th><th>费用</th></tr>"+sub_html+"</table></ul>";
                            }

                             $(".chufang_list").html(html);

                        }else{
                            $(".chufang_list h4").html("暂无缴费信息");
                            $("#confirm").css({"visibility":"hidden"});
                            $("#fanhui").css({"visibility":"hidden"});
                            $("#tuichu").css({"visibility":"visible"});
                        }
       
                    }else{
                        $("#confirm").css({"visibility":"hidden"});
                        $("#fanhui").css({"visibility":"hidden"});
                        $("#tuichu").css({"visibility":"visible"});
                        $(".chufang_list h4").html(data['chufang']['result']['execute_message']);
                    }
                 }else{
                        $("#confirm").css({"visibility":"hidden"});
                        $("#fanhui").css({"visibility":"hidden"});
                        $("#tuichu").css({"visibility":"visible"});
                        $(".jiuzhen_op_area .tips").text(data['head']['retmsg']);
                        $("#jz_card_no").val("")
                        $("#card_no").val("");
                          daojishi(60);
                    }
                       
                }
            });
        break;
        /********************自费缴费信息展示确认 划价*************************/
        case "ic_pay_chufang_show":
            //导航条---开始
            $("#tishi_dian1").hide();
            $("#tishi_dian2").hide();
            $("#tishi_dian3").show();
            $("#tishi_dian4").hide();
            $("#tishi_2").css({"color":"#666","font-size":"24px"});
            $("#tishi_3").css({"color":"#ff7800","font-size":"26px"});
            //导航条---结束
        daojishi(60);
        var times_order_no = "";
        var index_load2="";
        $("input[name='times_order_no[]']:checked").each(function(i, n){    
                times_order_no += n.value+";";
        })      
        if(times_order_no==""){
             layer.msg('请至少选择一项', {icon: 15,time:2000});
             return;
        }
        var params ={"card_no":$("#card_no").val(),"op_code":$("#op_code").val(),"zzj_id":$("#zzj_id").val(),"card_code":$("#card_code").val(),"patient_id":$("#patient_id").val()};
            $.ajax({
                url:"__URL__/ic_jiaofei_huajia",
                type:'post',
                dataType:'json',
                data:params,
                beforSend:function(){
                    $("#fanhui").css({"visibility":"hidden"});
                    $("#confirm").css({"visibility":"hidden"});
                    $("#tuichu").css({"visibility":"hidden"});
                },
                success:function(data){                    
                    daojishi(60);
                    layer.close(index_load);
                    if(data['head']['succflag']=="1"){
                        $("#op_now").val("ic_jiaofei_xinxi_queren");
                        $("#fanhui").css({"visibility":"visible"});
                        $("#tuichu").css({"visibility":"visible"});
                        $("#confirm").css({"visibility":"visible"});
                        $(".mtnum2").hide();
                        $(".chose_time").hide();
                        $(".jiaofei_queren").show();
                        var charge_total = data['body']['chargetamt'];//总金额
                        var cash = data['body']['personamt'];//自费
                        var zhzf = data['body']['siacctnow'];//账户支付
                        var tczf = data['body']['siacctnow'];//医保支付
                        var hjsj = data['head']['actdate'];//划价时间
                        $("#charge_total").val(charge_total);//将自费加医保总金额放入隐藏域
                        $("#cash").val(cash);//将自费金额放入隐藏域
                        $("#zhzf").val(zhzf);//将丈夫支付金额放入隐藏域
                        $("#tczf").val(tczf);//将医保支付金额放入隐藏域
                        $("#hjsj").val(hjsj);//将划价时间放入隐藏域
                        $("#sf_djh").val(data['body']['rctpno']);//将划价时间放入隐藏域
                        $(".jiaofei_queren .p1 .uname").text($("#patient_name").val());
                        $(".jiaofei_queren .p2 .card_no").text($("#card_no").val());
                        $(".jiaofei_queren .p6 .ksmc").text($("#ksmc").val());
                        $(".jiaofei_queren .p6 .jfrq").text($("#hjsj").val());
                        $(".jiaofei_queren .p6 .charge_total").text($("#charge_total").val());
                        $(".jiaofei_queren .p6 .cash").text($("#cash").val());
                        $(".jiaofei_queren .p6 .ybzf").text($("#tczf").val());
                    }else{
                        $("#fanhui").css({"visibility":"visible"});
                        $("#tuichu").css({"visibility":"visible"});
                        $("#confirm").css({"visibility":"visible"});                       
                        $(".chufang_area").show();
                        $("#op_now").val("ic_pay_chufang_show");
                        layer.alert(data['head']['retmsg'], {
                            icon: 6,
                            skin: 'layer-ext-moon',
                            time:5000,
                        });
                    }
                }
            });
        break;
       /********************自费缴费信息展示确认 划价*************************/
        case "yb_pay_chufang_show":
            //导航条---开始
            $("#tishi_dian1").hide();
            $("#tishi_dian2").hide();
            $("#tishi_dian3").show();
            $("#tishi_dian4").hide();
            $("#tishi_2").css({"color":"#666","font-size":"24px"});
            $("#tishi_3").css({"color":"#ff7800","font-size":"26px"});
            //导航条---结束
        daojishi(100);
        var times_order_no = "";
        var index_load2="";
        $("input[name='times_order_no[]']:checked").each(function(i, n){    
                times_order_no += n.value+";";
        })      
        if(times_order_no==""){
             layer.msg('请至少选择一项', {icon: 15,time:2000});
             return;
        } 
        $("#fanhui").css({"visibility":"hidden"});
        $("#tuichu").css({"visibility":"hidden"});
        $("#confirm").css({"visibility":"hidden"});
        var index_load="";
        index_load = layer.msg('数据请求中,请稍后...', {icon: 16,time:20000});      
        var params ={"card_no":$("#card_no").val(),"op_code":$("#op_code").val(),"zzj_id":$("#zzj_id").val(),"card_code":$("#card_code").val(),"patient_id":$("#patient_id").val()};
            $.ajax({
                url:"__URL__/yibao_jiaofei_huajia",
                type:'post',
                dataType:'json',
                data:params,
                beforSend:function(){
                    index_load = layer.msg('数据请求中,请稍后...', {icon: 16,time:20000});
                    $("#fanhui").css({"visibility":"hidden"});
                    $("#confirm").css({"visibility":"hidden"});
                    $("#tuichu").css({"visibility":"hidden"});
                },
                success:function(data){                   
                    daojishi(60);
                    layer.close(index_load);
                    if(data['head']['succflag']=="1"){

                        $("#fanhui").css({"visibility":"visible"});
                        $("#tuichu").css({"visibility":"visible"});
                        $("#confirm").css({"visibility":"visible"});
                        $("#op_now").val("yb_jiaofei_xinxi_queren");
                        $(".mtnum2").hide();
                        $(".chose_time").hide();
                        $(".jiaofei_queren").show();
                        var charge_total = data['body']['chargetamt'];//总金额
                        var cash = data['body']['personamt'];//自费
                        var zhzf = data['body']['Grzhzf'];//账户支付
                        var tczf = data['body']['Ybzf'];//医保支付
                        var hjsj = data['head']['actdate'];//划价时间
                        $("#charge_total").val(charge_total);//将自费加医保总金额放入隐藏域
                        $("#cash").val(cash);//将自费金额放入隐藏域
                        $("#zhzf").val(zhzf);//将丈夫支付金额放入隐藏域
                        $("#tczf").val(tczf);//将医保支付金额放入隐藏域
                        $("#hjsj").val(hjsj);//将划价时间放入隐藏域
                        $("#sf_djh").val(data['body']['rctpno']);//将划价时间放入隐藏域
                        $(".jiaofei_queren .p1 .uname").text($("#patient_name").val());
                        $(".jiaofei_queren .p2 .card_no").text($("#card_no").val());
                        $(".jiaofei_queren .p6 .ksmc").text($("#ksmc").val());
                        $(".jiaofei_queren .p6 .jfrq").text($("#hjsj").val());
                        $(".jiaofei_queren .p6 .charge_total").text($("#charge_total").val());
                        $(".jiaofei_queren .p6 .cash").text($("#cash").val());
                        $(".jiaofei_queren .p6 .ybzf").text($("#tczf").val());
                        $(".jiaofei_queren .p6 .p_zhzf").text($("#zhzf").val());                      

                    }else{
                        $("#fanhui").css({"visibility":"visible"});
                        $("#tuichu").css({"visibility":"visible"});
                        $("#confirm").css({"visibility":"visible"});
                        $(".chufang_area").show();
                        $("#op_now").val("yb_pay_chufang_show");                       
                        layer.alert(data['head']['retmsg'], {
                            icon: 6,
                            skin: 'layer-ext-moon',
                            time:10000,
                        });
                    }
                }
            });
        break;
        case "chose_yb_card":
            window.external.AllowCardIn();//允许社保进卡
            interval = setInterval(getYibaoInfo,"1000");
            interval3.push(interval);
        break;
        case "ic_jiaofei_xinxi_queren":
                    //导航条---开始
                    $("#tishi_dian1").hide();
                    $("#tishi_dian2").hide();
                    $("#tishi_dian3").hide();
                    $("#tishi_dian4").show();
                    $("#tishi_3").css({"color":"#666","font-size":"24px"});
                    $("#tishi_4").css({"color":"#ff7800","font-size":"26px"});
                    //导航条---结束
                    if($("#cash").val()==0){
                        var out_trade_no = $("#zzj_id").val()+$("#pat_code").val()+new Date().Format("yyyyMMddmmss");
                        $("#stream_no").val(out_trade_no);
                        $(".mtnum2").hide();
                        $(".pay_success").show();
                        $(".pay_success h3").html("费用确认中,请稍候...");
                        $("#confirm").css({"visibility":"hidden"});
                        $("#fanhui").css({"visibility":"hidden"});
                        $("#tuichu").css({"visibility":"hidden"});
                        paySuccessSendToHis($("#card_code").val());
                    }else{
                        $(".mtnum2").hide();
                        $(".jiaofei_queren").hide();
                        $(".chose_pay_type_area").show();
                        daojishi(180);
                        $("#confirm").css({"visibility":"hidden"});
                        $("#op_now").val("chose_pay_type");
                        
                        }
        
        break;
        case "yb_jiaofei_xinxi_queren":
                //导航条---开始
                $("#tishi_dian1").hide();
                $("#tishi_dian2").hide();
                $("#tishi_dian3").hide();
                $("#tishi_dian4").show();
                $("#tishi_3").css({"color":"#666","font-size":"24px"});
                $("#tishi_4").css({"color":"#ff7800","font-size":"26px"});
                //导航条---结束
                 if($("#cash").val()==0){
                        var out_trade_no = $("#zzj_id").val()+$("#pat_code").val()+new Date().Format("yyyyMMddmmss");
                        $("#stream_no").val(out_trade_no);
                        $(".mtnum2").hide();
                        $(".pay_success").show();
                        $(".pay_success h3").html("费用确认中,请稍候...");
                        $("#confirm").css({"visibility":"hidden"});
                        $("#fanhui").css({"visibility":"hidden"});
                        $("#tuichu").css({"visibility":"hidden"});
                        paySuccessSendToHis($("#card_code").val());
                    }else{
                            $(".mtnum2").hide();
                            $(".jiaofei_queren").hide();
                            $(".chose_pay_type_area").show();
                            daojishi(180);
                            $("#confirm").css({"visibility":"hidden"});
                            $("#op_now").val("chose_pay_type");
                        
                        }
         
        break;
        default:
            return false;
        break;
    }
        return false;
})





/******
**返回按钮功能处理
****/
$("#fanhui").on("click",function(){
    //alert($("#op_now").val());
    switch($("#op_now").val()){
        //从选择卡类型界面返回到首页
        case "jiaofei_chose_card_type":
            $("#op_now").val("jiaofei_chose_card_type");
            window.location.href="__APP__/ZiZhu/Index";
        break;
        // 输入就诊卡号,返回到选择卡类型页面
        case "ic_get_pat_info":
            $("#jz_card_no").val("");
            $(".jiuzhen_op_area").hide();
            $(".chose_card_type_area").show();
            daojishi(60);
            $("#confirm").css({"visibility":"hidden"});
            $("#op_now").val("jiaofei_chose_card_type");
             window.external.send(1,4); //关闭灯带 
            daojishi(60);
        break;
        // 输入身份证号,返回到选择卡类型页面
        case "sfz_put_sfz":
            $("#jz_card_no").val("");
            $(".jiuzhen_op_area_sfz").hide();
            $(".chose_card_type_area").show();
            daojishi(60);
            $("#confirm").css({"visibility":"hidden"});
            $("#op_now").val("jiaofei_chose_card_type");
             window.external.send(1,4); //关闭灯带 
            daojishi(60);
        break;
        // 从插入医保卡界面返回到选择卡类型界面
        case "chose_yb_card":
            window.external.send(1,4); //关闭灯带           
            window.external.MoveOutCard();
            window.external.DisAllowCardIn();
            for(var key in interval3){
                clearTimeout(interval3[key]);
            }
            $(".yb_op_area").hide();;
            $(".chose_card_type_area").show();
            $("#confirm").css({"visibility":"hidden"});
            $("#fanhui").css({"visibility":"visible"});
            $("#tuichu").css({"visibility":"visible"});
            $("#op_now").val("jiaofei_chose_card_type");
            daojishi(60);
        break;
       
        // 从就诊卡处方展示页面，返回到就诊卡,身份证,医保卡获取获取病人信息
        case "ic_pay_chufang_show":
            //导航条---开始
            $("#tishi_dian1").hide();
            $("#tishi_dian2").show();
            $("#tishi_dian3").hide();
            $("#tishi_dian4").hide();
            $("#tishi_3").css({"color":"#666","font-size":"24px"});
            $("#tishi_2").css({"color":"#ff7800","font-size":"26px"});
            //导航条---结束
            // 获取卡类型          
            if($("#card_code").val()=="3"){
                $(".mtnum2").hide();
                $(".chose_room").hide();
                $(".jiuzhen_op_area").show();
                $(".chufang_list").html("");
                daojishi(60)
                $("#confirm").css({"visibility":"visible"});
                $("#op_now").val("ic_get_pat_info");
            }
        break;
          // 从就诊卡处方展示页面，返回到就诊卡,身份证,医保卡获取获取病人信息
        case "yb_pay_chufang_show":
            // 获取卡类型
            $("#card_code").val();
            if($("#card_code").val()=="1"){
                $(".mtnum2").hide();
                $(".chose_room").hide();
                $(".yb_op_area").show();
                $(".chufang_list").html("");
               daojishi(60)
                window.external.MoveOutCard();
                for(var key in interval3){
                    clearTimeout(interval3[key]);
                }
                interval = setInterval(getYibaoInfo,"1000");
                interval3.push(interval);
                $("#op_now").val("chose_yb_card");
            }
        break;
        // 从缴费信息确认返回到处方展示页面
        case "ic_jiaofei_xinxi_queren":
            //导航条---开始
            $("#tishi_dian1").hide();
            $("#tishi_dian2").show();
            $("#tishi_dian3").hide();
            $("#tishi_dian4").hide();
            $("#tishi_3").css({"color":"#666","font-size":"24px"});
            $("#tishi_2").css({"color":"#ff7800","font-size":"26px"});
            //导航条---结束
            $(".mtnum2").hide();
            $(".jiaofei_queren").hide();
            $(".chufang_area").show();
            $(".jiaofei_dj").show();//缴费按钮显示
            daojishi(60);
            $("#confirm").css({"visibility":"visible"});
            $("#tuichu").css({"visibility":"visible"});
            if($("#card_code").val()=="1"){
                $("#fanhui").css({"visibility":"hidden"});
            }else{
                $("#fanhui").css({"visibility":"hidden"});
            }
            $("#op_now").val("ic_pay_chufang_show");
        break;
         // 从缴费信息确认返回到处方展示页面
        case "yb_jiaofei_xinxi_queren":
            //导航条---开始
            $("#tishi_dian1").hide();
            $("#tishi_dian2").show();
            $("#tishi_dian3").hide();
            $("#tishi_dian4").hide();
            $("#tishi_3").css({"color":"#666","font-size":"24px"});
            $("#tishi_2").css({"color":"#ff7800","font-size":"26px"});
            //导航条---结束
            $(".mtnum2").hide();
            $(".jiaofei_queren").hide();
            $(".chufang_area").show();
            $(".jiaofei_dj").show();//缴费按钮显示
            daojishi(60);
            $("#confirm").css({"visibility":"visible"});
            $("#tuichu").css({"visibility":"visible"});
            $("#fanhui").css({"visibility":"hidden"});            
            $("#op_now").val("yb_pay_chufang_show");
        break;
        // 从选择支付方式返回到缴费信息确认页面
        case "chose_pay_type":
            //导航条---开始
            $("#tishi_dian1").hide();
            $("#tishi_dian2").hide();
            $("#tishi_dian3").show();
            $("#tishi_dian4").hide();
            $("#tishi_4").css({"color":"#666","font-size":"24px"});
            $("#tishi_3").css({"color":"#ff7800","font-size":"26px"});
            //导航条---结束
            $(".mtnum2").hide();
            $(".chose_pay_type_area").hide();
            $(".jiaofei_queren").show();
            $("#card_code").val();
            if($("#card_code").val()=="3"){
                $("#op_now").val("ic_jiaofei_xinxi_queren");
            }else{
                 $("#op_now").val("yb_jiaofei_xinxi_queren");
            }
           daojishi(60);
            $("#fanhui").css({"visibility":"visible"});
            $("#tuichu").css({"visibility":"visible"});
            $("#confirm").css({"visibility":"visible"});
            $(".jiaofei_queren .p1 .uname").text($("#patient_name").val());
            $(".jiaofei_queren .p2 .card_no").text($("#card_no").val());
            $(".jiaofei_queren .p6 .ksmc").text($("#ksmc").val());
            $(".jiaofei_queren .p6 .jfrq").text($("#hjsj").val());
            $(".jiaofei_queren .p6 .charge_total").text($("#charge_total").val());
            $(".jiaofei_queren .p6 .cash").text($("#cash").val());
            $(".jiaofei_queren .p6 .ybzf").text($("#tczf").val());
            
            
           
        break;
    }                              
})
})

/********交易记录*******/
function pay_record(business_type,card_type,pat_card_no,id_card_no,pat_id,pat_name,pat_sex,charge_total,cash,zhzf,tczf,trading_state,his_state,trade_no,zzj_id,stream_no,pay_type){
        //alert(dept_code+","+dept_name+","+doctor_code+","+doctor_name+","+card_type+","+business_type+","+pat_card_no+","+healthcare_card_no+","+id_card_no+","+pat_id+","+pat_name+","+pat_sex+","+charge_total+","+cash+","+zhzf+","+tczf+","+trading_state+","+healthcare_card_trade_state+","+his_state+","+bank_card_id+","+reg_info+","+trade_no+","+zzj_id+","+stream_no);
        var params = {"business_type":business_type,"card_type":card_type,"pat_card_no":pat_card_no,"id_card_no":id_card_no,"pat_id":pat_id,"pat_name":pat_name,"pat_sex":pat_sex,"charge_total":charge_total,"cash":cash,"zhzf":zhzf,"tczf":tczf,"trading_state":trading_state,"his_state":his_state,"trade_no":trade_no,"zzj_id":zzj_id,"stream_no":stream_no,"pay_type":pay_type}; 
        //alert("开始记录交易数据");
        $.ajax({
            url:"__URL__/witeJyRecordToDataBase", 
            type:'post',
            dataType:'json',
            data:params,
            success:function(data){
                
            }
        })
}

/**
*日志记录函数
**/
function writeLog(logtxt,logtype){
    var params = {"log_txt":logtxt,"log_type":logtype,"card_code":$("#card_code").val(),"card_no":$("#card_no").val(),"patient_id":$("#patient_id").val(),"direction":"操作步骤","op_code":$("#op_code").val(),"zzj_id":$("#zzj_id").val()};
    $.ajax({
            url:"__URL__/writeLogs", 
            type:'post',
            dataType:'json',
            data:params,
            success:function(data){}
    })
}
function getIcCardNo(){
    var card_no3 = 91224916;
    // var card_no3 = window.external.DcrfGetSecBlockData();
    if (card_no3 != "") {
        // 获取就诊卡卡号
        // $(".jiuzhen_op_area .tips").text(" ");
        $("#card_no").val(card_no3);
        $("#confirm").trigger("click");
    }else{
        // $(".jiuzhen_op_area .tips").text("读取卡号失败，请重新贴卡");
    }
    return;
}
//读取身份证方法
function getCardNoS(){
    //var card_no =window.external.GetCardNo();
    // var card_no2 = window.external.sfz_card_read();
    // if(card_no2!=""){
        // if(card_no2!="请重放身份证" && card_no2!="开usb失败" && card_no2!="读卡失败"){
            // writeLog("二代身份证读卡器获取身份证信息成功");
            // var sfz = card_no2.split(",");
            // for(var key in interval3)
            // {
            //     clearInterval(interval3[key]);
            // }
            // var s0 = sfz[0];//姓名
            // var s1 = sfz[1];//性别
            // var s2 = sfz[2];//民族
            // var s3 = sfz[3];//出生日期
            // var s4 = sfz[4];//住址
            // var s5 = sfz[5];//身份证号
            // var s6 = sfz[6];//签发机关
            // var s7 = sfz[7];//有效期开始日期
            // var s8 = sfz[8];//有效期截止日期else
            // 身份证作为卡号放入输入框中
            var s5 = "123123111111111111";
            $("#jz_card_no_sfz").val(s5);
            $("#card_no").val(s5);
            $("#confirm").trigger("click");
        // }else{
        //     $(".put_shenfenzheng .tips").html(card_no2);
        // }
    // }
}

/*****************获取医保患者信息************************/
function getYibaoInfo(){
    // var flag ="";
    // flag = window.external.ReadStatus();//获取读卡器状态, 有卡返回true, 无卡返回false
    var flag ="123";
    if(flag){
        for(var key in interval3){
            clearTimeout(interval3[key]);
        }
        setTimeout(function(){
            $(".yb_op_area .tips").show().text('医保患者数据读取中,请稍后...');
            // 查询医保卡信息
            var params = {"op_code":$("#op_code").val(),"card_code":$("#card_code").val(),"zzj_id":$("#zzj_id").val()};
            $.ajax({
                url:"__URL__/yibao_getPatInfo",
                type:'post',
                dataType:'json',
                data:params,               
                success:function(data){
                    //导航条---开始
                    $("#tishi_dian1").hide();
                    $("#tishi_dian2").show();
                    $("#tishi_dian3").hide();
                    $("#tishi_dian4").hide();
                    $("#tishi_1").css({"color":"#666","font-size":"24px"});
                    $("#tishi_2").css({"color":"#ff7800","font-size":"26px"});
                    //导航条---结束
                    // window.external.send(1,4); //关闭灯带
                    $(".yb_op_area .tips").show().text('');
                    if(data['head']['succflag']=="1"){
                         daojishi(60);
                        $("#op_now").val("yb_pay_chufang_show");
                        $("#confirm").css({"visibility":"hidden"});
                        $("#fanhui").css({"visibility":"hidden"});
                        $("#tuichu").css({"visibility":"visible"});
                        $(".mtnum2").hide();
                        $(".chufang_area").show();
                        var pat_name = data['body']['name'];//患者姓名
                        var card_no = data['body']['medcardno'];//医保卡号
                        var pat_id = data['body']['medid'];//患者ID
                        var patient_sex = data['body']['sex'];//患者性别
                        var age =data["body"]["age"];
                         //var personcount =  data['body']['Personcount'];
                           // alert(personcount);
                            // $("#personcount").val(personcount); 
                        $("#patient_age").val(age);
                         $("#card_no").val(card_no);
                        $("#patient_name").val(pat_name); // 病人姓名放入隐藏域
                        $("#patient_id").val(pat_id); // 病人ID放入隐藏域
                        $("#patient_sex").val(patient_sex); // 病人ID放入隐藏域
                        $(".chufang_area #jz_name").text(pat_name);
                        if(data['chufang']['result']['execute_flag']==1){                         
                            var html="";
                            $("#confirm").css({"visibility":"visible"});
                            $("#fanhui").css({"visibility":"hidden"});
                            var flist = data['chufang']['datarow']["0"]['attr'];   //处方药品信息为空 值为0                         
                            if(flist != "0"){
                                var cflist = data['chufang']['datarow']
                                 for(var i=0;i<cflist.length;i++){
                                  var sub_html = "";
                                  var sub_item = data['chufang']['datarow'][i]['sub'];  //判断是否有药品信息
                                  if(sub_item !="0"){
                                     for(var m=0;m<sub_item.length;m++){
                                      sub_html+="<tr><td align='center'>"+(m+1)+"</td><td>"+sub_item[m]['itemname']+"</td><td>"+sub_item[m]['quantity']+"</td><td>"+sub_item[m]['price']+"</td><td>"+sub_item[m]['unit']+"</td><td>"+sub_item[m]['amt']+"</td></tr>";
                                       }
                                      }else{
                                           sub_html+="<tr><td align='center'>"+(m+1)+"</td><td></td><td></td><td></td><td></td><td></td></tr>";

                                        }
                              
                               
                                html+="<ul><li class='chk'><input type='checkbox' name='times_order_no[]' value='"+cflist[i].attr.chargeid+"'  checked='checked' /></li><li class='one'>"+cflist[i].attr.chargeid+"</li><li class='two'>"+cflist[i].attr.departmentname+"</li><li class='thr'>"+cflist[i].attr.chargeamt+"</li><li class='four'>"+cflist[i].attr.meddate+"</li><li class='five z1'>展开</li><table class='detail' style='display:none;'><tr><th>序号</th><th>名称</th><th>数量</th><th>单价</th><th>单位</th><th>费用</th></tr>"+sub_html+"</table></ul>";
                            }

                             $(".chufang_list").html(html);

                        }else{
                            $("#confirm").css({"visibility":"hidden"});
                            $("#fanhui").css({"visibility":"hidden"});
                            $("#tuichu").css({"visibility":"visible"});
                            $(".chufang_list h4").html("暂无缴费信息");
                        }
                    }else{

                        $("#confirm").css({"visibility":"hidden"});
                        $("#fanhui").css({"visibility":"hidden"});
                        $("#tuichu").css({"visibility":"visible"});
                        $(".chufang_list h4").html(data['chufang']['result']['execute_message']);
                     }                         
                                                  
                }else{
                    if(data['head']['retmsg'] == "识别卡信息有效性不成功(\\)!"){
                            $(".mtnum2").hide();
                            $(".yb_op_area").show();
                            daojishi(60);
                            $("#fanhui").css({"visibility":"visible"});
                            $("#confirm").css({"visibility":"hidden"});
                            $("#tuichu").css({"visibility":"visible"});
                            $(".yb_op_area .tips").html("");
                            $(".yb_op_area .tips").html("识别卡信息有效性不成功(\\)!，请重新插卡！");
                            window.external.MoveOutCard();
                            interval = setInterval(getYibaoInfo, "1000");
                            interval3.push(interval);
                        }
                    }
                }
            });
        }, 2500);
        
    }
}
/*************查询缴费详细信息*******************/
function chaxun(obj){
    var list = $(obj).attr("list");
        layer.open({
            title:'缴费详细信息',
            type: 1,
            // skin: 'layui-layer-rim', //加上边框
            area: ['640px', '500px'], //宽高
           	skin: 'demo-class', //样式类
            btn: ['确定'],
            time:100000,
            content: '<div style="margin:20px ;background:F7F8F8#;"><table border="1" width="600" cellspacing="0" style="font-size:20px;">'+list+'</table></div>'
        });
        
}

/********退款********/
function do_tuikuan(trade_no,out_trade_no,total_amount,operator_id){
    var pay_type = $("#pay_type").val();
    var params = {"pay_type":pay_type,"trade_no":trade_no,"out_trade_no":out_trade_no,"total_amount":total_amount,"operator_id":$("#zzj_id").val()};
    $.ajax({
        url:"__URL__/ajax_tuikuan",
        type:'post',
        dataType:'json',
        data:params,
        success:function(data1){
            switch(pay_type){
                case "alipay":
                    if(data1.message.Code=="10000"){
                        writeLog("支付宝退款成功");
                       
                        $(".pay_success h3").show().html("缴费失败,退款成功,请重新操作！");
                        
                    }else{
                        writeLog("支付宝退款失败");
                        $(".pay_success h3").show().html("缴费失败,请去收费窗口处理");
                        daojishi(10);
                        if($("#card_code").val() == "2" || $("#card_code").val() == "3"){
                             //保存失败
                                    var age =$("#patient_age").val();//患者年龄                                            
                                    var ID =  $("#patient_id").val();//患者ID  门诊号
                                    var sex = $("#patient_sex").val();//患者性别;
                                       if(sex == "1"){
                                              sex = '男';
                                        }else{
                                              sex = '女';
                                        }        
                                  
                                    var s1="";
                                    var pos = 0;
                                    s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                    s1 += "<tr font='黑体' type='text' size='12' x='20' y='" + (pos += 10) + "' >首都医科大学附属北京潞河医院(缴费)</tr>";
                                    s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+ID+"</tr>";
                                    if($("#card_code").val()=="2"){
                                        var card_code ="身份证";
                                    }
                                    if($("#card_code").val()=="3"){
                                        var card_code ="就诊卡";
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='35' y='" + (pos += 55) + "' >卡类型:"+card_code+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                     if($("#pay_type").val()=="yhk" && data['head']['succflag']=="2"){
                                      s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";                           
                                      s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >银行卡已退费</tr>";

                                    }else{
                                      s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";
                                      s1 += "<tr font='黑体' type='text' size='25' x='45' y='" + (pos += 40) + "' >请保存此凭证</tr>";
                                      s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >请当天去窗口处理</tr>";

                                    };
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >---------------------------------------------</tr>";
                                    s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 15) + "' >门诊号:"+ID+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >姓名:"+$("#patient_name").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >性别:"+sex+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >年龄:"+age+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >总费用："+$("#charge_total").val()+"元</tr>";
                                    if($("#pay_type").val()=="alipay"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝支付："+$("#cash").val()+"元</tr>";
                                    }
                                    if($("#pay_type").val()=="yhk"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡支付："+$("#cash").val()+"元</tr>";
                                    }
                                    if($("#pay_type").val()=="wxpay"){
                                       s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信支付："+$("#cash").val()+"元</tr>";
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >个人账户："+$("#zhzf").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保基金支付："+$("#tczf").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >实收:"+$("#cash").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >机器编号:"+$("#zzj_id").val()+"</tr>";
                                    //s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >缴费时间:"+date+"</tr>";
                                    if($("#pay_type").val()=="alipay"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝帐号："+$("#idCard").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝单号："+$("#stream_no").val()+"</tr>";
                                    }
                                    
                                    if($("#pay_type").val()=="wxpay"){
                                        s1 += "<tr font='黑体' type='text' size='9' x='10' y='" + (pos += 20) + "' >微信交易单号："+$("#stream_no").val()+"</tr>";
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付状态:支付成功</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >流水号："+$("#trade_no").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请保存此凭证，做为退费凭证</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                    s1 += "</print_info>";
                                    // alert(s1);
                                    window.external.paint(s1);
                

                        }else{
                                  var age =$("#patient_age").val();//患者年龄                                            
                                    var ID =  $("#patient_id").val();//患者ID  门诊号
                                    var sex = $("#patient_sex").val();//患者性别;
                                       if(sex == "1"){
                                              sex = '男';
                                        }else{
                                              sex = '女';
                                        }        
                                    //保存失败
                                   // var riqi =  data['result']['info']['account'];//HIS返回挂号日期时间
                                    var s1="";
                                    var pos = 0;
                                    s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                    s1 += "<tr font='黑体' type='text' size='12' x='20' y='" + (pos += 10) + "' >首都医科大学附属北京潞河医院(缴费)</tr>";
                                    s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+ID+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 55) + "' >卡类型:医保卡</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                   if($("#pay_type").val()=="yhk" && data['head']['succflag']=="2"){
                                      s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";                           
                                      s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >银行卡已退费</tr>";

                                    }else{
                                      s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";
                                      s1 += "<tr font='黑体' type='text' size='25' x='45' y='" + (pos += 40) + "' >请保存此凭证</tr>";
                                      s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >请当天去窗口处理</tr>";

                                    };
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >---------------------------------------------</tr>";
                                    s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 15) + "' >门诊号:"+ID+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保卡号:"+$("#card_no").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >姓名:"+$("#patient_name").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >性别:"+sex+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >年龄:"+age+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >总费用："+$("#charge_total").val()+"元</tr>";
                                    if($("#pay_type").val()=="alipay"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝支付："+$("#cash").val()+"元</tr>";
                                    }
                                    if($("#pay_type").val()=="yhk"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡支付："+$("#cash").val()+"元</tr>";
                                    }
                                    if($("#pay_type").val()=="wxpay"){
                                       s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信支付："+$("#cash").val()+"元</tr>";
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >个人账户："+$("#zhzf").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保基金支付："+$("#tczf").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >实收:"+$("#cash").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >机器编号:"+$("#zzj_id").val()+"</tr>";
                                   // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >缴费时间:"+date+"</tr>";
                                    if($("#pay_type").val()=="alipay"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝帐号："+$("#idCard").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝单号："+$("#stream_no").val()+"</tr>";
                                    }
                                    
                                    if($("#pay_type").val()=="wxpay"){
                                        s1 += "<tr font='黑体' type='text' size='9' x='10' y='" + (pos += 20) + "' >微信交易单号："+$("#stream_no").val()+"</tr>";
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付状态:支付成功</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >流水号："+$("#trade_no").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >失败类型：his失败</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请保存此凭证，做为退费凭证</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                    s1 += "</print_info>";
                                    // alert(s1);
                                    window.external.paint(s1);

                        };


                       
                    }
                break;
                case "wxpay":
                    if(data1.message.result_code=="SUCCESS"){
                        daojishi(15);
                        writeLog("微信退款成功");
                        $(".pay_success h3").show().html("缴费失败,退款成功,请重新操作！");
                       
                    }else{
                        writeLog("微信退款失败");
                        $(".pay_success h3").show().html("缴费失败,请去收费窗口处理");
                        daojishi(10);
                        if($("#card_code").val() == "3"){
                             //保存失败
                                    var age =$("#patient_age").val();//患者年龄                                            
                                    var ID =  $("#patient_id").val();//患者ID  门诊号
                                    var sex = $("#patient_sex").val();//患者性别;
                                       if(sex == "1"){
                                              sex = '男';
                                        }else{
                                              sex = '女';
                                        }        
                                  
                                    var s1="";
                                    var pos = 0;
                                    s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                    s1 += "<tr font='黑体' type='text' size='12' x='20' y='" + (pos += 10) + "' >首都医科大学附属北京潞河医院(缴费)</tr>";
                                    s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+ID+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 55) + "' >卡类型:就诊卡</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                     if($("#pay_type").val()=="yhk" && data['head']['succflag']=="2"){
                                      s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";                           
                                      s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >银行卡已退费</tr>";

                                    }else{
                                      s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";
                                      s1 += "<tr font='黑体' type='text' size='25' x='45' y='" + (pos += 40) + "' >请保存此凭证</tr>";
                                      s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >请当天去窗口处理</tr>";

                                    };
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >---------------------------------------------</tr>";
                                    s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 15) + "' >门诊号:"+ID+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >姓名:"+$("#patient_name").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >性别:"+sex+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >年龄:"+age+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >总费用："+$("#charge_total").val()+"元</tr>";
                                    if($("#pay_type").val()=="alipay"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝支付："+$("#cash").val()+"元</tr>";
                                    }
                                    if($("#pay_type").val()=="yhk"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡支付："+$("#cash").val()+"元</tr>";
                                    }
                                    if($("#pay_type").val()=="wxpay"){
                                       s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信支付："+$("#cash").val()+"元</tr>";
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >个人账户："+$("#zhzf").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保基金支付："+$("#tczf").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >实收:"+$("#cash").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >机器编号:"+$("#zzj_id").val()+"</tr>";
                                    //s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >缴费时间:"+date+"</tr>";
                                    if($("#pay_type").val()=="alipay"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝帐号："+$("#idCard").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝单号："+$("#stream_no").val()+"</tr>";
                                    }
                                    
                                    if($("#pay_type").val()=="wxpay"){
                                        s1 += "<tr font='黑体' type='text' size='9' x='10' y='" + (pos += 20) + "' >微信交易单号："+$("#stream_no").val()+"</tr>";
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付状态:支付成功</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >流水号："+$("#trade_no").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请保存此凭证，做为退费凭证</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                    s1 += "</print_info>";
                                    // alert(s1);
                                    window.external.paint(s1);
                

                        }else{
                                  var age =$("#patient_age").val();//患者年龄                                            
                                    var ID =  $("#patient_id").val();//患者ID  门诊号
                                    var sex = $("#patient_sex").val();//患者性别;
                                       if(sex == "1"){
                                              sex = '男';
                                        }else{
                                              sex = '女';
                                        }        
                                    //保存失败
                                   // var riqi =  data['result']['info']['account'];//HIS返回挂号日期时间
                                    var s1="";
                                    var pos = 0;
                                    s1 = "<?xml version='1.0' encoding='utf-8'?>" + "<print_info width='300' height='500'>";
                                    s1 += "<tr font='黑体' type='text' size='12' x='20' y='" + (pos += 10) + "' >首都医科大学附属北京潞河医院(缴费)</tr>";
                                    s1 += "<tr font='黑体' type='barcode' width='115' height='55' size='10' x='100' y='" + (pos += 30) + "' >"+ID+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 55) + "' >卡类型:医保卡</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                   if($("#pay_type").val()=="yhk" && data['head']['succflag']=="2"){
                                      s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";                           
                                      s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >银行卡已退费</tr>";

                                    }else{
                                      s1 += "<tr font='黑体' type='text' size='25' x='80' y='" + (pos += 30) + "' >缴费失败</tr>";
                                      s1 += "<tr font='黑体' type='text' size='25' x='45' y='" + (pos += 40) + "' >请保存此凭证</tr>";
                                      s1 += "<tr font='黑体' type='text' size='25' x='10' y='" + (pos += 40) + "' >请当天去窗口处理</tr>";

                                    };
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >---------------------------------------------</tr>";
                                    s1 += "<tr font='黑体' type='text' size='13' x='10' y='" + (pos += 15) + "' >门诊号:"+ID+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保卡号:"+$("#card_no").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >姓名:"+$("#patient_name").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >性别:"+sex+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >年龄:"+age+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >总费用："+$("#charge_total").val()+"元</tr>";
                                    if($("#pay_type").val()=="alipay"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝支付："+$("#cash").val()+"元</tr>";
                                    }
                                    if($("#pay_type").val()=="yhk"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >银行卡支付："+$("#cash").val()+"元</tr>";
                                    }
                                    if($("#pay_type").val()=="wxpay"){
                                       s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >微信支付："+$("#cash").val()+"元</tr>";
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >个人账户："+$("#zhzf").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >医保基金支付："+$("#tczf").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >实收:"+$("#cash").val()+"元</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >机器编号:"+$("#zzj_id").val()+"</tr>";
                                   // s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >缴费时间:"+date+"</tr>";
                                    if($("#pay_type").val()=="alipay"){
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝帐号："+$("#idCard").val()+"</tr>";
                                        s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付宝单号："+$("#stream_no").val()+"</tr>";
                                    }
                                    
                                    if($("#pay_type").val()=="wxpay"){
                                        s1 += "<tr font='黑体' type='text' size='9' x='10' y='" + (pos += 20) + "' >微信交易单号："+$("#stream_no").val()+"</tr>";
                                    }
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >支付状态:支付成功</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >流水号："+$("#trade_no").val()+"</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >失败类型：his失败</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 10) + "' >---------------------------------------------</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 20) + "' >*温馨提示：请保存此凭证，做为退费凭证</tr>";
                                    s1 += "<tr font='黑体' type='text' size='10' x='10' y='" + (pos += 40) + "' >.</tr>";
                                    s1 += "</print_info>";
                                    // alert(s1);
                                    window.external.paint(s1);

                        };



                    }
                break;
            }
        }
    })      
}
//ocx控件方法
//初始化控件

// 对Date的扩展，将 Date 转化为指定格式的String
// 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符， 
// 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字) 
// 例子： 
// (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423 
// (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18 
Date.prototype.Format = function (fmt) { //author: meizz 
    var o = {
        "M+": this.getMonth() + 1, //月份 
        "d+": this.getDate(), //日 
        "h+": this.getHours(), //小时 
        "m+": this.getMinutes(), //分 
        "s+": this.getSeconds(), //秒 
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
        "S": this.getMilliseconds() //毫秒 
    };
    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
    return fmt;
}
</script>
<style type="text/css">
</style>
<title>自助缴费</title>
</head>
<body>
<!-- 自助机ID -->
<input type="hidden" id="zzj_id"  value=""/> 
<!-- 是否实时结算 -->
<input type="hidden" class="inhide" id="if_ck" />
<!-- 缴费时就诊id -->
<input type="hidden" class="inhide" id="jzid" />
<!-- 缴费时就诊id对应的处方号-->
<input type="hidden" class="inhide" id="order_no" />
<!-- 预约日期 -->
<input type="hidden" class="inhide" id="yuyue_riqi" />
<!-- 一级科室代码 -->
<input type="hidden" class="inhide" id="yjksdm" />
<!-- 二级科室代码 -->
<input type="hidden" class="inhide" id="ksdm" />
<!-- 二级科室名称 -->
<input type="hidden" class="inhide" id="ksmc" />
<!-- 医生姓名 -->
<input type="hidden" class="inhide" id="ysxm" />
<!-- 医生代码 -->
<input type="hidden" class="inhide" id="ysdm" />
<!-- 挂号级别代码 号别编码 -->
<input type="hidden" class="inhide" id="hbbm" />
<!-- 挂号级别名称 号别名称 -->
<input type="hidden" class="inhide" id="hbmc" />
<!-- 上下午代码 -->
<input type="hidden" class="inhide" id="sxw" />
<!-- 上下午名称 -->
<input type="hidden" class="inhide" id="apm" />
<!-- 出诊时间 -->
<input type="hidden" class="inhide" id="czsj" />
<!--添加了号源类别的隐藏域 1是专家号,2是普通号-->
<input type="hidden" class="inhide" id="hao_type" />
<!--收费单据号-->
<input type="hidden" class="inhide" id="sf_djh" />
<!-- 预约ID -->
<input type="hidden" class="inhide" id="yyid" />
<!-- 操作码 -->
<input type="hidden" class="inhide" id="op_code" value=""/>
<input type="hidden" class="inhide" id="dingshi" value=""/>
<!-- 卡号 -->
<input type="hidden" class="inhide" id="card_no" value=""/>
<!-- 卡类型 -->
<input type="hidden" class="inhide" id="card_code" value=""/>

<input type="hidden" class="inhide" id="times" value="" />
<!--添加了病人ID-->
<input type="hidden" class="inhide" id="patient_id" />
<!-- 病人姓名 -->
<input type="hidden" class="inhide" id="patient_name" value="" />
<!--病人性别  -->
<input type="hidden" class="inhide" id="patient_sex" value="" />
<!-- 病人年龄 -->
<input type="hidden" class="inhide" id="patient_age" value="" />
<!-- 医事服务费 -->
<input type="hidden" class="inhide" id="ysfwf" value=""/>
<!-- 自助缴费划价时间 -->
<input type="hidden" class="inhide" id="hjsj" value=""/>
<!-- 医保,自费总金额 -->
<input type="hidden" class="inhide" id="charge_total" value=""/>
<!-- 自费金额 -->
<input type="hidden" class="inhide" id="cash" />
<!-- 银行卡金额 -->
<input type="hidden" class="inhide" id="total_amount" />
<!-- 账户支付金额 -->
<input type="hidden" class="inhide" id="zhzf" />
<!-- 医保支付金额 -->
<input type="hidden" class="inhide" id="tczf" />
<!-- 账户支付 -->
<input type="hidden" class="inhide" id="zhzf" value=""/>
<input type="hidden" class="inhide" id="pay_seq" value=""/>
<!--本地交易流水号-->
<input type="hidden" id="stream_no" value=""/> 
<!-- 买家支付宝，微信交易流水号 -->
<input type="hidden" class="inhide" id="trade_no" value=""/>
<!-- 买家支付宝,微信账号 -->
<input type="hidden" class="inhide" id="idCard" value=""/>
<!-- 支付宝，微信交易状态 -->
<input type="hidden" class="inhide" id="PayStatus" value=""/>
<input type="hidden" class="inhide" id="times_order_no"  value=""/>
<input type="hidden" class="inhide" id="dept_code" value=""/>
<input type="hidden"  class="inhide" id="tansType" value="00"  />
<input type="hidden" class="inhide" id="reponse_name" value="" />
<input type="hidden" id="daojishi" class="inhide" value=""/>
<input type="hidden" id="business_type" class="inhide" value=""/>
<input type="hidden" id="pay_type" class="inhide" value=""/>
<input type="hidden" id="yb_flag" class="inhide" value=""/>
<input type="hidden" id="record_sn" class="inhide" value=""/>
<input type="hidden" id="bank_card_num" class="inhide" value=""/>
<input type="hidden" id="personcount" class="inhide" value=""/>
<!--银联隐藏域-->
<input type="hidden" id="refund_bank" class="inhide" value=""/>
<input type="hidden" id="T_RespCode" class="inhide" value=""/>
<input type="hidden" id="RespCode" class="inhide" value=""/>
<input type="hidden" id="RespInfo" class="inhide" value=""/>
<input type="hidden" id="CardNo" class="inhide" value=""/>
<input type="hidden" id="Amount" class="inhide" value=""/>
<input type="hidden" id="Trace" class="inhide" value=""/>
<input type="hidden" id="Batch" class="inhide" value=""/>
<input type="hidden" id="TransDate" class="inhide" value=""/>
<input type="hidden" id="TransTime" class="inhide" value=""/>
<input type="hidden" id="Ref" class="inhide" value=""/>
<input type="hidden" id="Auth" class="inhide" value=""/>
<input type="hidden" id="Memo" class="inhide" value=""/>
<input type="hidden" id="Lrc" class="inhide" value=""/>

<input type="hidden" id="bank_success" value=""/>
<!-- 记录当前操作步骤 -->
<input type="hidden" id="op_now" />
<div class="main_body">
     <div style="width:70px; height:70px;float:left;" id="close"></div>
    <div id="downcount"></div>
    <div id="show_times">{$riqi} {$xq} &nbsp;{$sj}</div>
    <!-- 导航条 -->
    <div id="daohangtiao">
        <div id="liuchengdian1"></div>
        <div id="liuchengdian2"></div>
        <div id="liuchengdian3"></div>
        <div id="liuchengdian4"></div>
        <div id="tishi_dian1"></div>
        <div id="tishi_dian2"></div>
        <div id="tishi_dian3"></div>
        <div id="tishi_dian4"></div>
        <div id="tishi_1">选择卡类型</div>
        <div id="tishi_2">选择缴费处方</div>
        <div id="tishi_3">确认缴费信息</div>
        <div id="tishi_4">选择支付方式</div>
    </div>
    <!-- 导航条 -->
    
   <div class="main_left_2"  calss="block">
        <div class="print_notice mtnum2" style="display:none">
            <h3>打印机缺纸请联系工作人员</h3>
        </div>
        <!--选择卡类型-->
        <div class="chose_card_type_area mtnum2" style="display:block;">
            <h3>请您选择卡类型</h3>
            
            <ul>
                <li class="ic" id="xz_ic">就诊卡</li>
                <li class="sfz" id="xz_sfz">身份证</li>
                <li class="yibao" id="xz_yibao">医保卡</li>
            </ul>
        </div>
        
        <!----就诊卡操作界面---->
        <div class="jiuzhen_op_area mtnum2" style="display:none;">
            <h3>请按图示位置感应就诊卡</h3>
            <!-- <input type="text" class="iptx" value="" id="jz_card_no" /> -->
            <div class="j_keybord_area">
                <ul class="img_view"></ul>
               <!--  <ul class="key">
                    <li class="num" param="1">1</li>
                    <li class="num" param="2">2</li>
                    <li class="num" param="3">3</li>
                    <li class="num" param="4">4</li>
                    <li class="num" param="5">5</li>
                    <li class="num" param="6">6</li>
                    <li class="num" param="7">7</li>
                    <li class="num" param="8">8</li>
                    <li class="num" param="9">9</li>
                    <li class="num" param="0">0</li>
                    <li class="num" param="x">x</li>
                    <li class="del">删除</li>
                </ul> -->
                <div class="tips"></div>
            </div>
        </div>
        <!----S身份证操作界面---->
        <div class="jiuzhen_op_area_sfz mtnum2" style="display:none;">
            <h3>请刷身份证或输入身份证号</h3>
            <input type="text" class="iptx" value="" id="jz_card_no_sfz" />
            <div class="j_keybord_area_sfz">
                <ul class="img_view" id="img_view_sfz">
                </ul>
                <ul class="key">
                    <li class="num" param="1">1</li>
                    <li class="num" param="2">2</li>
                    <li class="num" param="3">3</li>
                    <li class="num" param="4">4</li>
                    <li class="num" param="5">5</li>
                    <li class="num" param="6">6</li>
                    <li class="num" param="7">7</li>
                    <li class="num" param="8">8</li>
                    <li class="num" param="9">9</li>
                    <li class="num" param="0">0</li>
                    <li class="num" param="x">x</li>
                    <li class="del">删除</li>
                </ul>
                <div class="tips"></div>
            </div>
        </div>
        <!---------------医保卡插入操作界面-------------------->
        <div class="yb_op_area mtnum2" style="display:none;">
            <h3>请插入您的医保卡</h3>
            <div class="tips"></div>
        </div>
        
        <!-- 预约记录 -->
        <div class="yuyue_record mtnum2" style="display:none;">
          <!--------添加了患者的姓名-------->
          <span style="color:#009FD6;font-size:35px;position:absolute;left:135px;" id="jz_name" ></span>
            <h3 style="font-size:35px">请取消预约信息</h3>
            <div class="bar_tit">
                <ul>
                    <li class="one">就诊科室</li>
                    <li class="two">金额</li>
                    <li class="thr">日期</li>
                    <li class="four">时间</li>
                </ul>
            </div>
            <div class="record_list"></div>
        </div>
        <div class="guahao_queren mtnum2" style="display:none">
            <h3>请确认挂号信息</h3>
            <ul>
                <li class="p1"> <span class="txt txt_1">姓名：</span><span class="uname"></span></li>
                <li class="p2">
                    <span class="txt">卡号：</span><span class="card_no"></span>            
                </li>
                <li class="p6">
                    <span class="txt">号别：</span><span class="hbmc"></span>
                    <span class="txt txt_2">科室：</span><span class="ksmc"></span>
                </li>
                <li class="p6">
                    <span class="txt">医生：</span><span class="ysxm"></span>
                    <span class="txt txt_2">医事服务费：</span><span class="ysfwf"></span>
                </li>
                <li class="p6">
                    <span class="txt">就诊日期：</span><span class="czsj"></span>
                <li class="p6">
                    <span class="txt">总金额：</span><span class="charge_total"></span>
                </li>
                <li class="p6"><span class="txt">自费金额：</span><span class="cash"></span></li>
                <li class="p6"><span class="txt yb_txt">医保支付：</span><span class="ybzf"></span></li>
            </ul>
        </div>
        <div class="print_notice mtnum2" style="display:none">
            <h3>打印机缺纸请联系工作人员</h3>
        </div>
        <!--------处方列表-------->
        <!-- <div class="chufang_area mtnum2" style="display:none;"> -->
          <!--------添加了患者的姓名-------->
          <!-- <span style="color:#009FD6;font-size:35px;position:absolute;left:135px;" class="jz_name" ></span>
            <h3 style="font-size:35px">请确认缴费信息</h3>
            <div class="bar_tit">
                <ul>
                    <li class="two">就诊科室</li>
                    <li class="thr">金额</li>
                    <li class="four">日期</li>
                    <li class="five">是否实时结算</li>
                </ul>
            </div>
            <div class="chufang_list"><h4></h4></div>
        </div> -->
         <div class="chufang_area mtnum2" style="display:none;">
          <!--------添加了患者的姓名-------->
          <span id="jz_name" ></span>
            <h3>请确认缴费信息</h3>
            <div class="bar_tit">
                <ul>
                    <li class="one">单据号</li>
                    <li class="two">就诊科室</li>
                    <li class="thr">金额</li>
                    <li class="four">日期</li>
                    <!-- <li class="five">自费</li> -->
                </ul>
            </div>
            <div class="chufang_list"><h4></h4></div>
        </div>
        <div class="jiaofei_queren mtnum2" style="display:none">
            <h3>请确认缴费信息</h3>
            <ul>
                <li class="p1">
                    <span class="txt txt_1">姓名：</span><span class="uname"></span>
                    <span class="txt dingwei1">卡号：</span><span class="card_no">123</span>
                </li>
                <!-- <li class="p2">
                    <span class="txt">卡号：</span><span class="card_no"></span>            
                </li> -->
                <li class="p6">
                    <span class="txt">总金额：</span><span class="charge_total"></span>
                    <span class="txt dingwei1">自费金额：</span><span class="cash dingwei3"></span>
                </li>
                <!-- <li class="p6"><span class="txt">自费金额：</span><span class="cash"></span></li> -->
                <li class="p6">
                    <span class="txt yb_txt">医保支付：</span><span class="ybzf dingwei2"></span>
                    <span class="txt dingwei1">缴费日期：</span><span class="jfrq dingwei2"></span>
                </li>
                 <li class="p6"><span class="txt yb_txt">医保个人账户支付：</span><span class="p_zhzf"></span></li>
                <!-- <li class="p6">
                    <span class="txt">缴费日期：</span><span class="jfrq"></span>
                </li> -->
            </ul>
        </div>
        <div class="fenjie_result mtnum2" style="display:none">
            <h3>请确认缴费信息</h3>
            <ul>
                <li class="p1"> <span class="txt txt_1">姓名：</span><span class="uname"></span></li>
                <li class="p2">
                    <span class="txt">卡号：</span><span class="card_no"></span>            
                </li>
                <li class="p3">
                    <span class="txt">总金额：</span><span class="p_chare_totle"></span>
                </li>
                <li class="p6"><span class="txt">自费金额：</span><span class="cash"></span></li>
                <li class="p6"><span class="txt yb_txt">医保支付：</span><span class="ybzf"></span></li>
                 <!-- <li class="p6"><span class="txt yb_txt">医保支付：</span><span class="ybzf"></span></li> -->
                <!-- <li class="p4"><span class="txt">现金支付：</span><span class="p_cash"></span></li>
                <li class="p6"><span class="txt">统筹支付：</span><span class="p_tczf"></span></li>
                <li class="p5"><span class="txt yb_txt">医保个人账户支付：</span><span class="p_zhzf"></span></li>
                <li class="p7"><span class="txt">医保个人账户总额：</span><span class="yb_zh"></span></li> -->
            </ul>
        </div>
        <!--选择卡类型-->
        <div class="chose_pay_type_area mtnum2" style="display:none">
            <h3>请选择支付方式</h3>
            <div style="font-size:20px;"><b>缴费提示：</b><br>
                1、请选择支付宝,微信，银行卡三种方式进行支付。
                2、不支持信用卡支付。
                3、为避免无效支付，请在计时结束前完成支付。
                4、支付后未打印回执单，请去窗口咨询。
                5、银联卡,医保卡如有变形会造成不退卡，请去窗口办理业务。
                </div>
            <ul>
                <li id="pay_zhifubao" class="zhifubao">支付宝</li>
                <li id="pay_weixin" class="weixin">微信</li>
                <li id="pay_bank" class="bank_s">银行卡</li>
            </ul>
        </div>
        <!--支付宝二维码显示区-->
        <div class="pay_ma_show mtnum2" style="display:none">
            <h3>扫一扫付款</h3>
            <div id="pay_qr_kuang">
                <div id="hedui_1">请核对您的支付信息</div>
                <div id="hedui_2"><span id="hedui_2_name">姓名：</span><span id="hedui_2_val"></span></div>
                <div id="hedui_3"><span id="hedui_2_money">支付金额：</span><span class="pay_val"></span></div>
                <!-- <div class="pay_val"></div> -->
                <div id="hedui_4">若信息不一致，请勿支付</div>
            </div>
            <div id="pay_saoma_kuang">
                <div class="erweima">
                    <img src="" width="240" />
                </div>
                <div class="tips">请在五分钟内付款</div>
            </div>
            
        </div>
        <!--银行卡-->
        <div class="bank mtnum2" style="display:none">
            <h3>请插入您的银行卡</h3>
            <div class="tips" id="bank_tips"></div>
        </div>
        <div class="bank_password mtnum2" style="display:none;">
            <h3>请输入您的银行卡密码</h3>
            <input type="password" class="PinField1" id="PinField" />
            <div class="bank_notice_area">
                <ul class="bank_img_view"></ul>
                <ul class="bank_lang">
                    <li class="lang">请不要透漏您的密码！</li>
                    <li class="lang">输入密码时请注意遮挡！</li>
                    <li class="lang">密码不足六位请按确认键！</li>
                </ul>
            </div>
            <div class="tips"></div>
        </div>
        <!--------------付款成功-------------->
        <div class="pay_success mtnum2" style="display:none">
            <div id="yes_success"></div>
            <div id="not_success"></div>
            <h3>操作完毕 !</h3>
        </div>
   </div>
   <div class="btn_area" style="display:none;">
    <ul>
        <li id="confirm"></li>
        <li id="fanhui"></li>
        <li id="tuichu"></li>
    </ul>
   </div>
</div>
</div>
<script> 
</script> 
</body>
</html>